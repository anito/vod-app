export const base =
  process.env.NODE_ENV === "development"
    ? "https://physio.mbp/v1"
    : "https://vod.webpremiere.de/v1";

async function send({ method, path, data, token }) {
  const fetch = process.browser ? window.fetch : require("node-fetch");
  const fullpath = path.startsWith("http") ? path : `${base}/${path}`;

  const opts = {
    method,
    headers: {
      Accept: "application/json", // make cakephp happy (required for ajax-rendering)
    },
    credentials: "include",
  };

  if (data) {
    opts.headers["Content-Type"] = "application/json";
    opts.body = JSON.stringify(data);
  }

  if (token) {
    opts.headers["Authorization"] = `Bearer ${token}`;
  }

  return fetch(fullpath, opts)
    .then((res) => res.text())
    .then((res) => {
      try {
        return JSON.parse(res);
      } catch (_) {}
    })
    .catch(() => {});
}

export function get(path, token) {
  return send({ method: "GET", path, token });
}

export function del(path, token) {
  return send({ method: "DELETE", path, token });
}

export function post(path, data, token) {
  return send({ method: "POST", path, data, token });
}

export function put(path, data, token) {
  return send({ method: "PUT", path, data, token });
}
