<script context="module">
  import UAParser from "ua-parser-js";

  const browserName = new UAParser().getBrowser().name;
  const maxChromeStreams = 5;

  let players = new Set();
  let now = new Date().getTime();
</script>

<script>
  import Video from "./Video.svelte";
  import { onMount } from "svelte";

  export let poster = "";
  export let src = "";
  export let type;
  export let paused = true;
  export let playhead;
  export let video;

  let videoElement;
  let controls = false; // if false use customControls
  let muted = false;
  let preload = "none";
  let autoplay = false;
  let className = "";

  export { className as class };

  onMount((_) => {
    players.add({
      video: videoElement,
      timestamp: now,
    });
  });

  $: ((playing) => {
    playing && pausePlayers();
    limitStreamsOnChrome();
  })(!paused);

  function pausePlayers() {
    players.forEach((player) => {
      if (player.video !== videoElement) {
        player.video.promise &&
          player.video.promise.then(() => {
            !player.video.paused && player.video.pause();
          });
      } else {
        player.timestamp = new Date().getTime();
      }
    });
  }

  function limitStreamsOnChrome() {
    if (browserName !== "Chrome") return;
    var _player, _players;
    _players = Array.from(players);
    _players = _players.filter(
      (player) => player.timestamp > now && player.video.paused
    );
    _player = _players
      .sort((a, b) => b.timestamp - a.timestamp)
      .slice(maxChromeStreams - 1)
      .shift();
    if (_player) {
      _player.video.src = "";
      _player.promise = null;
    }
  }
</script>

<Video
  class={className}
  bind:paused
  bind:videoElement
  bind:playhead
  on:player:paused
  on:player:canplay
  on:player:fwd
  on:player:rwd
  {poster}
  {preload}
  {muted}
  {src}
  {video}
  {type}
  {controls}
  {autoplay}
/>

<style>
</style>
