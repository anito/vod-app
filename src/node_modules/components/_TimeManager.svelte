<script>
  import * as api from 'api';
  import './icon-button.scss';
  import './date-range-picker.scss';
  import { goto, stores } from '@sapper/app';
  import { onMount, getContext } from 'svelte';
  import { createRedirectSlug } from 'utils';
  import List, { Item, Graphic, Separator, Text } from '@smui/list';
  import Button, { Label, Icon as ButtonIcon } from '@smui/button';
  import IconButton, { Icon } from '@smui/icon-button';
  import SimpleVideoCard from 'components/SimpleVideoCard';
  import { videos } from '../../stores/videoStore';
  import { users } from '../../stores/userStore';
  import { flash } from '../../stores/flashStore';
  import { infos } from '../../stores/infoStore';
  import { DateRangePicker, Header } from '@sveltejs/site-kit/';
  import Component from './_Component.svelte';
  import { startOfDay, endOfDay, formatISO9075, parseISO } from 'date-fns';
  import * as locales from 'date-fns/locale';
  import { toISODate, proxyEvent } from 'utils';
  import Dialog, { Title, Content, Actions, InitialFocus } from '@smui/dialog';
  import Radio from '@smui/radio';
  import { _, locale } from 'svelte-i18n';

  export let selectionUserId;

  const { page, session } = stores();
  const maxDate = undefined;
  const user = $session.user;
  const { getSnackbar, configSnackbar } = getContext('snackbar');
  const timespanSelections = [
    { title: 'text.1-month', value: 30 },
    { title: 'text.2-months', value: 60 },
    { title: 'text.3-months', value: 90 },
    { title: 'text.individually', value: 'self' },
  ];

  let root;
  let schedulingVideoId;
  let scheduleDialog;
  let removeDialog;
  let timespanSelection = timespanSelections[0].value;
  let timespanSelected;
  let firstDayOfWeek = 'monday';
  let snackbar;
  let code;
  let message;
  let filtered;
  let group;
  let currentUser;
  let selectedIndex;
  let selectionVideoId;
  let selectedVideo;
  let userVideos = [];
  let readout;
  let schedulingVideo = '';
  let expires;
  let isExpired;

  $: dateFormat = $locale.indexOf('de') != -1 ? 'dd. MMM yyyy' : 'yyyy-MM-dd';
  $: currentUserIndex = ((id) => $users.findIndex((usr) => usr.id === id))(selectionUserId);
  $: userVideos = $users[currentUserIndex] && $users[currentUserIndex].videos.sort(sortByEndDate);
  $: (() => (selectionVideoId = null))(selectionUserId);
  $: currentUser =
    (filtered = ((id) => $users.filter((usr) => usr.id === id))(selectionUserId)) && filtered.length && filtered[0];
  $: username = (currentUser && currentUser.name) || '';
  $: currentRole =
    (group = ((usr) => $session.groups && $session.groups.find((group) => group.id == usr.group_id))(currentUser)) &&
    group.name;
  $: joinData =
    (selectedVideo = currentUser && currentUser.videos.find((v) => v.id === selectionVideoId)) &&
    selectedVideo._joinData;
  $: startDate = (joinData && joinData.start && parseISO(joinData.start)) || startOfDay(new Date(0));
  $: endDate = (joinData && joinData.end && parseISO(joinData.end)) || endOfDay(new Date(0));
  $: expires = currentUser && currentUser.expires;
  $: isExpired = (expires && expires * 1000 < +new Date().getTime()) || false;
  $: noneUserVideos = $videos
    .filter((v) => {
      return !userVideos.find((uv) => {
        return v.id === uv.id && (!uv._joinData.end || new Date(uv._joinData.end) > new Date());
      });
    })
    .sort(sortByTitle);
  $: root && root.classList.toggle('datapicker--open', selectionVideoId);
  $: schedulingVideo = schedulingVideoId && $videos.find((video) => video.id === schedulingVideoId);
  $: schedulingVideoTitle = (schedulingVideo && schedulingVideo.title) || '';
  $: localeObject = ((l) => locales[l.slice(0, 2)])($locale);
  $: userIssues =
    ($infos.has(selectionUserId) && $infos.get(selectionUserId).params.filter((info) => info.type === 'issue')) || [];

  onMount(() => {
    root = document.documentElement;
    root.classList.add('timemanager--open');

    snackbar = getSnackbar();
    return () => root.classList.remove('timemanager--open', 'datapicker--open');
  });

  function sortByTitle(a, b) {
    let _a = (a.title && a.title.toUpperCase()) || '';
    let _b = (b.title && b.title.toUpperCase()) || '';
    return (_a < _b && -1) || (_a > _b && 1) || 0;
  }
  function sortByStartDate(a, b) {
    let aStart = a._joinData.start || new Date('3000');
    let bStart = b._joinData.start || new Date('3000');
    return new Date(bStart) - new Date(aStart);
  }
  function sortByEndDate(a, b) {
    let aEnd = a._joinData.end || new Date('3000');
    let bEnd = b._joinData.end || new Date('3000');
    return new Date(bEnd) - new Date(aEnd);
  }
  function openScheduleDialog(video) {
    schedulingVideoId = video.id;
    scheduleDialog.open();
  }
  function openRemoveDialog(e, video) {
    e.stopPropagation();
    schedulingVideoId = video.id;
    if (timeRemaining(video)) {
      removeDialog.open();
    } else {
      removeVideo();
    }
  }

  async function removeDialogCloseHandler(e) {
    if (e.detail.action === 'approved') {
      removeVideo();
    }
    schedulingVideoId = null;
  }

  async function scheduleDialogCloseHandler(e) {
    if (e.detail.action === 'accept') {
      let start = null;
      let end = null;

      timespanSelected = timespanSelection;
      if (timespanSelected === 'self') {
        selectionVideoId = schedulingVideoId;
      } else {
        let now = new Date();
        let time = new Date(now.getTime() + timespanSelected * 24 * 60 * 60 * 1000);
        start = toISODate(now);
        end = toISODate(time, true);
      }
      saveTime(schedulingVideoId, start, end);
      timespanSelection = timespanSelections[0].value;
      schedulingVideoId = null;
    }
  }

  async function itemSelectedHandler(e) {
    let { video } = e.detail;
    selectionVideoId = video.id == selectionVideoId ? null : video.id;
  }

  function onApplyHandler({ detail }) {
    const { startDate, endDate } = { ...detail };

    let isoStart = toISODate(startDate);
    let isoEnd = toISODate(endDate);

    saveTime(selectionVideoId, isoStart, isoEnd);
  }

  async function saveTime(id, start, end) {
    let associated = userVideos.filter((v) => v.id != id).map((v) => ({ id: v.id }));
    let data = {
      videos: [
        {
          id: id,
          _joinData: { start, end },
        },
        ...associated,
      ],
    };

    const res = await saveUser(data);

    if (res.success) {
      handleSuccess(res, $_('text.time-slot-updated'));
    } else {
      handleError(res);
    }
  }

  function timeRemaining(video) {
    if (!(video._joinData && video._joinData.end)) return 0;
    let end = new Date(video._joinData.end).toISOString();
    let now = new Date().toISOString();
    return Math.max(0, new Date(end) - new Date(now));
  }

  async function removeVideo() {
    let idx = userVideos.findIndex((itm) => itm.id === schedulingVideoId);
    let _userVideos = [...userVideos.slice(0, idx), ...userVideos.slice(idx + 1)];
    let ids = _userVideos.map((v) => v.id);

    let data = { videos: { _ids: [...ids] } };
    const res = await saveUser(data);

    if (res.success) {
      selectionVideoId === schedulingVideoId && (selectionVideoId = null);
      handleSuccess(res, $_('text.video-removed'));
    } else {
      handleError(res);
    }
  }

  function saveUser(data) {
    return api.put(`users/${selectionUserId}?lang=${$locale}`, data, user && user.token);
  }

  function handleSuccess(res, msg) {
    snackbar.isOpen && snackbar.close();
    users.put(res.data);

    message = msg || res.message || res.data.message;
    configSnackbar(message);
    snackbar.open();
  }

  function handleError(res) {
    let path;
    snackbar.isOpen && snackbar.close();

    message = res.message || res.data.message || res.statusText;
    code = (res.data && res.data.code) || res.status;

    if (400 <= code && code < 500) {
      configSnackbar(message);
      snackbar.open();
    } else {
      flash.update({ type: 'error', message });
      path = `login${createRedirectSlug($page)}`;
      configSnackbar(message, path);
      snackbar.open();
    }
  }

  function onSelection(e) {
    //
  }
</script>

<div
  class="grid-item user-videos"
  class:no-user-selected={!currentUser}
  class:no-videos={(userVideos && !userVideos.length) || currentRole === 'Administrator'}
>
  <Component>
    <div slot="header">
      <Header mdc h="5">
        {#if currentUser}
          <div class="flex">
            <span><strong>{username}</strong></span>
            <span class="uppercase flex-auto" style="font-weight: 400; text-align: right;"
              >| {$_('text.booked-classes')}</span
            >
          </div>
        {/if}
      </Header>
    </div>
    <List class="video-list" threeLine avatarList singleSelection bind:selectedIndex>
      {#if 'Administrator' !== currentRole}
        {#if userVideos && userVideos.length}
          {#each userVideos as video (video.id)}
            <SimpleVideoCard
              let:expired
              isUserVideo
              threeLine
              class="user-video video-list-item"
              on:itemSelected={itemSelectedHandler}
              selected={selectionVideoId === video.id}
              {video}
              {selectionUserId}
              emphasizeEmptyDate
            >
              {#if 'Administrator' === $session.role}
                <Button class="close-action-button button-shaped-round flex self-center" variant="unelevated">
                  <Icon class="material-icons">
                    {selectionVideoId === video.id ? 'close' : 'insert_invitation'}
                  </Icon>
                  <Label>{$_('text.scheduler')}</Label>
                </Button>
                <IconButton
                  class="self-center"
                  color="primary"
                  style="display: none;"
                  on:click={async () => await goto(`videos/${video.id}`)}
                >
                  <Icon class="material-icons">link</Icon>
                </IconButton>
                <IconButton
                  disabled={expired}
                  class="delete-action-button delete"
                  on:click={(e) => openRemoveDialog(e, video)}
                >
                  <Icon class="material-icons">remove_circle_outline</Icon>
                </IconButton>
              {/if}
            </SimpleVideoCard>
          {/each}
        {:else if currentUser}
          <div class="flex flex-1 flex-col self-center text-center">
            <div class="my-10">
              {@html $_('text.user-has-no-videos', { values: { name: username } })}
            </div>
          </div>
        {:else}
          <div class="flex flex-1 flex-col self-center text-center">
            <div class="my-10">
              {$_('text.user-doesnt-exist')}
            </div>
          </div>
        {/if}
      {:else if currentRole === 'Administrator'}
        <div class="flex flex-1 flex-col self-center text-center">
          <div class="my-10">{$_('text.admins-have-full-access')}</div>
        </div>
      {/if}
    </List>
  </Component>
</div>
{#if selectionVideoId}
  <div class="grid-item time">
    <Component>
      <div slot="header">
        <div class="">
          <Header mdc h="5">{readout}</Header>
          <button on:click={() => (selectionVideoId = null)} class="button-close" variant="unelevated">
            <Icon class="material-icons" style="vertical-align: middle;">close</Icon>
          </button>
        </div>
      </div>
      <DateRangePicker
        on:apply={onApplyHandler}
        on:selection={onSelection}
        bind:readout
        {firstDayOfWeek}
        {startDate}
        {endDate}
        {maxDate}
        {dateFormat}
        {localeObject}
        customHeaderHeight
        class="sm-header"
        disabled={!selectionVideoId}
        resetTrigger={selectionVideoId}
        weekGuides
        weekNumbers
        todayBtn
        twoPages
        resetViewBtn
        timePicker
        timePickerSeconds
        timePickerControls
        todayBtnText={$_('text.today')}
        cancelBtnText={$_('text.reset')}
        applyBtnText={$_('text.apply')}
        actionBtnClass="picker-btn mdc-button mdc-ripple-upgraded mdc-button--unelevated"
      />
    </Component>
  </div>
{:else}
  <div class="grid-item videos" class:no-videos={!noneUserVideos.length}>
    <Component>
      <div slot="header">
        <Header mdc h="5">
          <div class="uppercase" style="font-weight: 400; text-align: right;">{$_('text.more-classes')}</div></Header
        >
      </div>
      {#if noneUserVideos.length}
        <List class="video-list" twoLine avatarList singleSelection>
          {#each noneUserVideos as video (video.id)}
            <SimpleVideoCard
              let:unmanagable
              class="video"
              disabled={currentRole === 'Administrator'}
              {video}
              {selectionUserId}
            >
              <IconButton
                disabled={$session.role !== 'Administrator'}
                class="self-center"
                color="primary"
                style="display: none;"
                on:click={async () => await goto(`videos/${video.id}`)}
              >
                <Icon class="material-icons">link</Icon>
              </IconButton>
              <IconButton
                disabled={unmanagable}
                class="add-action-button add"
                color="primary"
                on:click={() => openScheduleDialog(video)}
              >
                <Icon class="material-icons">add_circle_outline</Icon>
              </IconButton>
            </SimpleVideoCard>
          {/each}
        </List>
      {:else}
        <div class="flex flex-1 flex-col self-center text-center">
          <div class="my-10">{$_('text.no-more-videos-available')}</div>
        </div>
      {/if}
    </Component>
  </div>
{/if}
<Dialog
  bind:this={scheduleDialog}
  aria-labelledby="list-selection-title"
  aria-describedby="list-selection-content"
  on:MDCDialog:closed={scheduleDialogCloseHandler}
>
  <Title id="list-selection-title">{$_('text.select-time-slot')}</Title>
  <Content id="list-selection-content">
    <List radioList>
      {#each timespanSelections as timespan, i}
        <Item use={i === 0 && [InitialFocus]}>
          <Graphic>
            <Radio bind:group={timespanSelection} value={timespan.value} />
          </Graphic>
          <Text>{$_(timespan.title)}</Text>
        </Item>
      {/each}
      {#if !currentUser.token || isExpired || !currentUser.active}
        <div class="mt-3">
          <Icon class="material-icons leading">warning</Icon>
          <p>
            {$_('text.account-inactive')}
          </p>
          <div class="reasons">
            {#each userIssues as issue}
              <Button variant="raised" on:click={() => proxyEvent(issue.eventType, { silent: true })}>
                <Label>{$_(issue.label)}</Label>
              </Button>
            {/each}
          </div>
        </div>
      {/if}
    </List>
  </Content>
  <Actions>
    <Button>
      <Label>{$_('text.cancel')}</Label>
    </Button>
    <Button action="accept" variant="unelevated">
      <Label>Ok</Label>
    </Button>
  </Actions>
</Dialog>
<Dialog
  bind:this={removeDialog}
  aria-labelledby="event-title"
  aria-describedby="event-content"
  on:MDCDialog:closed={removeDialogCloseHandler}
>
  <Title id="event-title">
    {$_('text.video-is-active')}
  </Title>
  <Content id="event-content">
    <p>{@html $_('messages.class-has-active-time-slot', { values: { title: schedulingVideoTitle } })}</p>
  </Content>
  <Actions>
    <Button action="none">
      <Label>{$_('text.cancel')}</Label>
    </Button>
    <Button action="approved" default use={[InitialFocus]} variant="unelevated">
      <Label>{$_('text.remove-class')}</Label>
    </Button>
  </Actions>
</Dialog>

<style>
  .grid-item {
    background: var(--back-grid-item);
  }
  .user-videos {
    grid-area: one;
    overflow: auto;
  }
  .time,
  .videos {
    grid-area: two;
    overflow: auto;
  }
  .time {
    background: #fff;
  }
  .no-user-selected {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  :global(.item > label) {
    width: 100%;
  }
  .button-close {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translate(50%, -50%);
  }
  .reasons > :global(*) {
    display: block;
    margin: 1em 0;
  }
</style>
