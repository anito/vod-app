<script>
  import * as api from "api.js";
  import "./icon-button.scss";
  import "./date-range-picker.scss";
  import { goto, stores } from "@sapper/app";
  import { onMount, getContext } from "svelte";
  import { createRedirectSlug } from "utils";
  import List, { Item, Graphic, Separator, Text } from "@smui/list";
  import Button, { Label, Icon as ButtonIcon } from "@smui/button";
  import IconButton, { Icon } from "@smui/icon-button";
  import SimpleVideoCard from "components/SimpleVideoCard";
  import { videos } from "../../stores/videoStore";
  import { users } from "../../stores/userStore";
  import { flash } from "../../stores/flashStore";
  import { DateRangePicker, Header } from "@sveltejs/site-kit/";
  import Component from "./_Component.svelte";
  import { startOfDay, endOfDay, formatISO9075, parseISO } from "date-fns";
  import * as locales from "date-fns/locale";
  import { toISODate } from "utils";
  import Dialog, { Title, Content, Actions, InitialFocus } from "@smui/dialog";
  import Radio from "@smui/radio";
  import MenuList from "components/_MenuList.svelte";

  export let selectionUserId;

  const { page, session } = stores();
  const maxDate = undefined;
  const user = $session.user;
  const { getSnackbar, configSnackbar } = getContext("snackbar");
  const timespanSelections = [
    { title: "1 Monat", value: 30 },
    { title: "2 Monate", value: 60 },
    { title: "3 Monate", value: 90 },
    { title: "selbst ausw채hlen", value: "self" },
  ];

  let root;
  let dialogVideoId;
  let scheduleDialog;
  let removeDialog;
  let timespanSelection = timespanSelections[0].value;
  let timespanSelected;
  let locale = locales.de;
  let dateFormat = "dd. MMM yyyy";
  let firstDayOfWeek = "monday";
  let snackbar;
  let code;
  let message;
  let filtered;
  let group;
  let currentUser;
  let selectedIndex;
  let selectionVideoId;
  let selectedVideo;
  let userVideos = [];
  let readout;
  let dialogVideo = "";
  let cardMenu;

  $: currentUserIndex = ((id) => $users.findIndex((usr) => usr.id === id))(
    selectionUserId
  );
  $: userVideos = $users[currentUserIndex] && $users[currentUserIndex].videos;
  $: (() => (selectionVideoId = null))(selectionUserId);
  $: currentUser =
    (filtered = ((id) => $users.filter((usr) => usr.id === id))(
      selectionUserId
    )) &&
    filtered.length &&
    filtered[0];
  $: currentRole =
    (group = ((usr) =>
      $session.groups &&
      $session.groups.find((group) => group.id == usr.group_id))(
      currentUser
    )) && group.name;
  $: joinData =
    (selectedVideo =
      currentUser &&
      currentUser.videos.find((v) => v.id === selectionVideoId)) &&
    selectedVideo._joinData;
  $: startDate =
    (joinData && joinData.start && parseISO(joinData.start)) ||
    startOfDay(new Date(0));
  $: endDate =
    (joinData && joinData.end && parseISO(joinData.end)) ||
    endOfDay(new Date(0));
  $: noneUserVideos = $videos.filter(
    (v) => !userVideos.find((uv) => v.id === uv.id)
  );
  $: root && root.classList.toggle("datapicker--open", selectionVideoId);
  $: dialogVideo =
    dialogVideoId && $videos.find((video) => video.id === dialogVideoId);

  onMount(() => {
    root = document.documentElement;
    root.classList.add("timemanager--open");

    snackbar = getSnackbar();
    return () => root.classList.remove("timemanager--open", "datapicker--open");
  });

  function openScheduleDialog(video) {
    dialogVideoId = video.id;
    scheduleDialog.open();
  }
  function openRemoveDialog(e, video) {
    e.stopPropagation();
    dialogVideoId = video.id;
    if (timeRemaining(video)) {
      removeDialog.open();
    } else {
      removeVideo();
    }
  }

  async function removeDialogCloseHandler(e) {
    if (e.detail.action === "approved") {
      removeVideo();
    }
    dialogVideoId = null;
  }

  function scheduleDialogCloseHandler(e) {
    if (e.detail.action === "accept") {
      let start = null;
      let end = null;

      timespanSelected = timespanSelection;
      if (timespanSelected === "self") {
        selectionVideoId = dialogVideoId;
      } else {
        let now = new Date();
        let time = new Date(
          now.getTime() + timespanSelected * 24 * 60 * 60 * 1000
        );
        start = toISODate(now);
        end = toISODate(time, true);
      }
      saveTime(dialogVideoId, start, end);
    }
    timespanSelection = timespanSelections[0].value;
    dialogVideoId = null;
  }

  async function itemSelectedHandler(e) {
    let { video } = e.detail;
    selectionVideoId = video.id == selectionVideoId ? null : video.id;
  }

  function onApplyHandler({ detail }) {
    const { startDate, endDate } = { ...detail };

    let isoStart = toISODate(startDate);
    let isoEnd = toISODate(endDate);

    saveTime(selectionVideoId, isoStart, isoEnd);
  }

  async function saveTime(id, start, end) {
    let associated = userVideos
      .filter((v) => v.id != id)
      .map((v) => ({ id: v.id }));
    let data = {
      videos: [
        {
          id: id,
          _joinData: { start, end },
        },
        ...associated,
      ],
    };

    const res = await saveUser(data);

    if (res.success) {
      handleSuccess(res, "Zeitfenster aktualisiert");
    } else {
      handleError(res);
    }
  }

  function timeRemaining(video) {
    if (!(video._joinData && video._joinData.end)) return 0;
    let end = new Date(video._joinData.end).toISOString();
    let now = new Date().toISOString();
    return Math.max(0, new Date(end) - new Date(now));
  }

  async function removeVideo() {
    let idx = userVideos.findIndex((itm) => itm.id === dialogVideoId);
    let _userVideos = [
      ...userVideos.slice(0, idx),
      ...userVideos.slice(idx + 1),
    ];
    let ids = _userVideos.map((v) => v.id);

    let data = { videos: { _ids: [...ids] } };
    const res = await saveUser(data);

    if (res.success) {
      selectionVideoId === dialogVideoId && (selectionVideoId = null);
      handleSuccess(res, "Video entfernt");
    } else {
      handleError(res);
    }
  }

  function saveUser(data) {
    return api.put(`users/${selectionUserId}`, data, user && user.token);
  }

  function handleSuccess(res, msg) {
    snackbar.isOpen && snackbar.close();
    users.put(res.data);

    message = msg || res.message || res.data.message;
    configSnackbar(message);
    snackbar.open();
  }

  function handleError(res) {
    let path;
    snackbar.isOpen && snackbar.close();

    message = res.message || res.data.message || res.statusText;
    code = (res.data && res.data.code) || res.status;

    if (400 <= code && code < 500) {
      configSnackbar(message);
      snackbar.open();
    } else {
      flash.update({ type: "error", message });
      path = `login${createRedirectSlug($page)}`;
      configSnackbar(message, path);
      snackbar.open();
    }
  }

  function onSelection(e) {
    //
  }
</script>

<style>
  .grid-item {
    background: var(--back-grid-item);
  }
  .user-videos {
    grid-area: one;
    overflow: auto;
  }
  .time,
  .videos {
    grid-area: two;
    overflow: auto;
  }
  .time {
    background: #fff;
  }
  .no-user-selected {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  :global(.item > label) {
    width: 100%;
  }
  .button-close {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translate(50%, -50%);
  }
</style>

<div
  class="grid-item user-videos"
  class:no-user-selected={!currentUser}
  class:no-videos={!userVideos.length || currentRole === 'Administrator'}>
  <Component>
    <div slot="header">
      <Header mdc h="5">
        <span> von <strong>{currentUser.name}</strong> gebuchte Kurse </span>
      </Header>
    </div>
    <List
      class="video-list"
      threeLine
      avatarList
      singleSelection
      bind:selectedIndex>
      {#if 'Administrator' !== currentRole}
        {#if userVideos.length}
          {#each userVideos as video (video.id)}
            <SimpleVideoCard
              disabled={'Administrator' !== $session.role}
              threeLine
              class="user-video video-list-item"
              on:itemSelected={itemSelectedHandler}
              on:itemSelected
              selected={selectionVideoId === video.id}
              {video}
              {selectionUserId}
              emptyDateText="kein Zeitfenster definiert"
              emphasizeEmptyDate>
              {#if 'Administrator' === $session.role}
                <Button
                  class="close-action-button button-shaped-round flex self-center"
                  variant="outlined">
                  <Icon class="material-icons">
                    {selectionVideoId === video.id ? 'close' : 'insert_invitation'}
                  </Icon>
                  <Label>Planer</Label>
                </Button>
                <IconButton
                  disabled={$session.role !== 'Administrator'}
                  class="self-center"
                  color="primary"
                  on:click={async () => await goto(`videos/${video.id}`)}>
                  <Icon class="material-icons">launch</Icon>
                </IconButton>
                <IconButton
                  class="delete-action-button delete"
                  on:click={(e) => openRemoveDialog(e, video)}>
                  <Icon class="material-icons">remove_circle_outline</Icon>
                </IconButton>
              {/if}
            </SimpleVideoCard>
          {/each}
        {:else}
          <div class="flex flex-1 flex-col self-center text-center">
            <div class="my-10">
              {@html `User <strong>${currentUser.name}</strong> has no subscriptions`}
            </div>
          </div>
        {/if}
      {:else if currentRole === 'Administrator'}
        <div class="flex flex-1 flex-col self-center text-center">
          <div class="my-10">Admins haben vollen Zugriff auf alle Videos</div>
        </div>
      {/if}
    </List>
  </Component>
</div>
{#if selectionVideoId}
  <div class="grid-item time">
    <Component>
      <div slot="header">
        <div class="">
          <Header mdc h="5">{readout}</Header>
          <button
            on:click={() => (selectionVideoId = null)}
            class="button-close"
            variant="outlined">
            <Icon class="material-icons" style="vertical-align: middle;">
              close
            </Icon>
          </button>
        </div>
      </div>
      <DateRangePicker
        on:apply={onApplyHandler}
        on:selection={onSelection}
        bind:readout
        customHeaderHeight
        class="sm-header"
        {locale}
        {firstDayOfWeek}
        {startDate}
        {endDate}
        {maxDate}
        {dateFormat}
        disabled={!selectionVideoId}
        resetTrigger={selectionVideoId}
        weekGuides
        weekNumbers
        todayBtn
        twoPages
        resetViewBtn
        timePicker
        timePickerSeconds
        timePickerControls
        todayBtnText="Heute"
        cancelBtnText="Reset"
        applyBtnText="Anwenden"
        actionBtnClass="picker-btn mdc-button mdc-ripple-upgraded mdc-button--unelevated" />
    </Component>
  </div>
{:else}
  <div class="grid-item videos" class:no-videos={!noneUserVideos.length}>
    <Component>
      <div slot="header">
        <Header mdc h="5">Weitere Kurse</Header>
      </div>
      {#if noneUserVideos.length}
        <List class="video-list" twoLine avatarList singleSelection>
          {#each noneUserVideos as video (video.id)}
            <SimpleVideoCard
              let:unmanagable
              class="video"
              emptyDateText={video.description}
              disabled={currentRole === 'Administrator'}
              {video}
              {selectionUserId}>
              <IconButton
                disabled={$session.role !== 'Administrator'}
                class="self-center"
                color="primary"
                on:click={async () => await goto(`videos/${video.id}`)}>
                <Icon class="material-icons">launch</Icon>
              </IconButton>
              <IconButton
                disabled={unmanagable}
                class="add-action-button add"
                color="primary"
                on:click={() => openScheduleDialog(video)}>
                <Icon class="material-icons">add_circle_outline</Icon>
              </IconButton>
              <div slot="listItems" />
            </SimpleVideoCard>
          {/each}
        </List>
      {:else}
        <div class="flex flex-1 flex-col self-center text-center">
          <div class="my-10">Keine weiteren Videos verf체gbar</div>
        </div>
      {/if}
    </Component>
  </div>
{/if}
<Dialog
  bind:this={scheduleDialog}
  aria-labelledby="list-selection-title"
  aria-describedby="list-selection-content"
  on:MDCDialog:closed={scheduleDialogCloseHandler}>
  <Title id="list-selection-title">Zeitraum festlegen</Title>
  <Content id="list-selection-content">
    <List radioList>
      {#each timespanSelections as timespan, i}
        <Item use={i === 0 && [InitialFocus]}>
          <Graphic>
            <Radio bind:group={timespanSelection} value={timespan.value} />
          </Graphic>
          <Text>{timespan.title}</Text>
        </Item>
      {/each}
    </List>
  </Content>
  <Actions>
    <Button>
      <Label>Abbrechen</Label>
    </Button>
    <Button action="accept">
      <Label>Ok</Label>
    </Button>
  </Actions>
</Dialog>
<Dialog
  bind:this={removeDialog}
  aria-labelledby="event-title"
  aria-describedby="event-content"
  on:MDCDialog:closed={removeDialogCloseHandler}>
  <Title id="event-title">
    {`${dialogVideo && dialogVideo.title} ist im Moment aktiv`}
  </Title>
  <Content id="event-content">
    Dieser Kurs verf체gt 체ber ein aktives Zeitfenster. Den Kurs
    {dialogVideo && dialogVideo.title}
    trotzdem entfernen?
  </Content>
  <Actions>
    <Button action="none">
      <Label>Abbrechen</Label>
    </Button>
    <Button action="approved" default use={[InitialFocus]}>
      <Label>Ja, bitte entfernen</Label>
    </Button>
  </Actions>
</Dialog>
