<script>
  import { onMount, onDestroy, tick } from 'svelte';
  import { sents } from '../../stores/sentStore';
  import { inboxes } from '../../stores/inboxStore';
  import List from '@smui/list';
  import SimpleMailCard from './_SimpleMailCard.svelte';
  import { _ } from 'svelte-i18n';

  export let type;
  export let selected;
  export let sort = 'DESC';
  export let selectionIndex;

  let list;
  let foundation;

  $: sortBit = sort === 'DESC' ? -1 : sort === 'ASC' ? 1 : 0;
  $: _mails = type === 'inboxes' ? $inboxes : type === 'sents' ? $sents : [];
  $: _mails = _mails.sort((a, b) => sortBit * (new Date(a.created) - new Date(b.created)));

  onMount(() => {
    foundation = list.getDefaultFoundation();
  });
  onDestroy(() => {});

  async function mailDestoyedHandler(e) {
    await tick();
    let index = foundation.focusNextElement(selectionIndex - 1);
    if (index < selectionIndex) {
      selectionIndex = index;
      foundation.focusNextElement(index - 1);
    }
  }
</script>

<List bind:this={list} class="mails-list {type}" twoLine avatarList singleSelection bind:selectedIndex={selectionIndex}>
  {#each _mails as mail (mail.id)}
    <SimpleMailCard
      on:mail:delete
      on:mail:toggleRead
      on:mail:destroyed={(e) => mailDestoyedHandler(e)}
      bind:selected
      {mail}
      {type}
    />
  {/each}
</List>

<style>
</style>
