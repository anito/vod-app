<script context="module">
  let loginAttempts = 0;
</script>

<script>
  import { onMount, getContext } from 'svelte';
  import { stores } from '@sapper/app';
  import { post, proxyEvent } from 'utils';
  import { flash } from '../../stores/flashStore';
  import { formGuard as frozen } from '../../stores/formGuard';
  import Button from '@smui/button/styled';
  import Textfield, { Input, Textarea } from '@smui/textfield/styled';
  import Icon from '@smui/textfield/icon/styled';
  import HelperText from '@smui/textfield/helper-text/styled';
  import { Label } from '@smui/common/styled';
  import Dialog, { Title as DialogTitle, Content, Actions, InitialFocus } from '@smui/dialog/styled';
  import { locale, _ } from 'svelte-i18n';

  const { session } = stores();
  const { getSnackbar, configSnackbar } = getContext('snackbar');

  // Fixtures
  const adminEmail = 'sampleadmin@webpremiere.de';
  const adminPassword = 'Test@005';
  const userEmail = 'sampleuser@webpremiere.de';
  const userPassword = 'Angela@005';

  let password = '';
  let email = '';
  let snackbar;
  let invalidTokenUserDialog;

  $session.user = null;
  $session.role = null;
  $session.groups = null;
  $session.expires = null;

  onMount(() => {
    defreeze();
    snackbar = getSnackbar();

    return () => defreeze();
  });

  async function submit(e) {
    freeze();
    flash.update({ message: $_('text.one-moment'), wait: -1 });

    const res = await post(`auth/login?lang=${$locale}`, {
      email,
      password,
    });

    if (res) {
      let type, wait;
      let message = res.message || res.data.message || res.statusText;

      /**
       * As for displaying the result message: there are two steps:
       * The flashStore handles the (wait) time the servers result message should stay visible.
       * After that (amount of time) the message will be set empty and will therefore be unmounted.
       * As a result a second message is triggered to fly in.
       * This second message will be either a welcome message (on success) or
       * a default message (on first appearance)
       *
       * The "servers wait" is only set on success === true, so for
       * an unseccessful login we must set the wait time here ourselfs
       */
      if (res.success) {
        type = 'success';
        // save into file session
        res.data.user && ($session.user = res.data.user) && ($session.role = res.data.user.group.name);
        res.data.groups && ($session.groups = res.data.groups);
        $session.expires = res.expires;

        /**
         * The server will set a "Token Renewed" flag in its response if an expired token was
         * automatically renewed
         * If the flag was set a dialog will appear on the next screen
         */
        if (res.data.renewed) localStorage.setItem('renewed', res.data.renewed);
        proxyEvent('session:started');
      } else {
        defreeze();
        reset();
        type = 'warning';
        wait = 5000;

        if (++loginAttempts > 3) invalidTokenUserDialog.open();
      }

      flash.update({ type, message, wait: res.data.wait || wait });
      configSnackbar(message);
      snackbar.open();
    }

    // TODO handle network errors
    // errors = res.errors;
  }

  function reset() {
    email = '';
    password = '';
  }

  function freeze() {
    frozen.update('frozen');
  }

  function defreeze() {
    frozen.update(false);
  }

  function setFields(type) {
    switch (type) {
      case 'admin':
        email = adminEmail;
        password = adminPassword;
        break;
      case 'user':
        email = userEmail;
        password = userPassword;
    }
  }

  function invalidTokenDialogCloseHandler(e) {
    loginAttempts = 0;
  }
</script>

<form on:submit|preventDefault={submit} method="post" class:frozen={$frozen}>
  <div class="login-grid">
    <span class="email-area lg:mr-2 flex flex-col">
      <Textfield
        variant="outlined"
        withLeadingIcon
        bind:value={email}
        label="Email"
        autocomplete="user-email"
        input$aria-controls="helper-text-outlined-email"
        input$aria-describedby="helper-text-outlined-email"
      >
        <Icon class="material-icons">mail</Icon>
      </Textfield>
      <HelperText id="helper-text-outlined-email">Your Email</HelperText>
    </span>
    <span class="pass-area lg:ml-2 flex flex-col">
      <Textfield
        variant="outlined"
        type="password"
        withTrailingIcon
        bind:value={password}
        label={$_('text.password')}
        autocomplete="user-password"
        input$aria-controls="helper-text-outlined-password"
        input$aria-describedby="helper-text-outlined-password"
      >
        <Icon class="material-icons">login</Icon>
      </Textfield>
      <HelperText id="helper-text-outlined-password">Your Password</HelperText>
    </span>
    <div class="button-area-one flex">
      <Button disabled={!(email && password)} class="login-button flex-1" type="submit" variant="raised">
        <Label>Login</Label>
      </Button>
    </div>
    <div class="button-area-two flex">
      <Button on:click={() => setFields('admin')} color="" class="login-button flex-1" type="submit" variant="raised">
        <Icon class="material-icons">supervisor_account</Icon>
        <Label>Wannabe Admin</Label>
      </Button>
    </div>
    <div class="button-area-three flex">
      <Button on:click={() => setFields('user')} color="" class="login-button flex-1" type="submit" variant="raised">
        <Icon class="material-icons">person</Icon>
        <Label>Wannabe User</Label>
      </Button>
    </div>
  </div>
</form>
<Dialog
  bind:this={invalidTokenUserDialog}
  aria-labelledby="info-title"
  aria-describedby="info-content"
  on:MDCDialog:closed={invalidTokenDialogCloseHandler}
>
  <DialogTitle id="info-title">{$_('text.contact-admin')}</DialogTitle>
  <Content id="info-content">
    <div class="item">
      {@html $_('messages.should-contact-admin')}
    </div>
  </Content>
  <Actions>
    <Button action="none">
      <Label>{$_('text.close')}</Label>
    </Button>
  </Actions>
</Dialog>

<style>
  .login-grid {
    display: grid;
    grid-gap: 5px;
    grid-row-gap: 0.5rem;
    grid-template-columns: 1fr;
    grid-template-rows: repeat(2, 1fr);
    grid-template-areas:
      'email'
      'pass'
      'button1'
      'button2'
      'button3';
  }
  .email-area {
    grid-area: email;
  }
  .pass-area {
    grid-area: pass;
  }
  .button-area-one {
    grid-area: button1;
  }
  .button-area-two {
    grid-area: button2;
  }
  .button-area-three {
    grid-area: button3;
  }

  @media screen and (min-width: 840px) {
    .login-grid {
      grid-template-areas:
        'email pass'
        'button1 button1'
        'button2 button3';
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: 2fr 1fr 1fr;
      grid-row-gap: 1rem;
    }

    .button-area-two :global(.login-button:only-child) {
      margin: 0;
    }
    .button-area-two :global(.login-button:nth-child(even)) {
      margin-left: 10px;
    }
    .button-area-two :global(.login-button:nth-child(odd)) {
      margin-right: 10px;
    }
  }
</style>
