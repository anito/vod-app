<script>
  import './chip.scss';
  import Chip, { Set, Icon, Text } from '@smui/chips';
  import { stores } from '@sapper/app';
  import { ticker } from '../../stores/tickerStore';
  import { _ } from 'svelte-i18n';

  export let prefix = 'text.session-expires';
  export { className as class };

  const { session } = stores();
  const FAILS = 2;

  let className = 'text-surface';
  let last,
    fail,
    fails = FAILS;

  Number.prototype.minDigits = function (m, locale = 'de-DE', options) {
    return this.toLocaleString(locale, {
      minimumIntegerDigits: m,
      ...options,
    });
  };

  function parse(ms) {
    if ((fail = isNaN(ms))) {
      return (--fails && last) || '--:--:--';
    }
    fails = FAILS;
    let tt, hrs, min, sec;
    tt = ms / 1000;
    sec = Math.floor(tt % 60).minDigits(2);
    min = Math.floor((tt / 60) % 60).minDigits(2);
    hrs = Math.floor(tt / 3600).minDigits(2);
    return (last = `${hrs}:${min}:${sec}`);
  }
</script>

{#if $session.user}
  <Set chips={[1]}>
    <Chip class={className} on:MDCChip:interaction>
      <Icon class="material-icons" leading>av_timer</Icon>
      <Text>
        <span>{prefix && $_(prefix)}</span>
        <span style="opacity: {fails < FAILS ? 0.5 : 1}">
          {parse($ticker)}
        </span>
      </Text>
    </Chip>
  </Set>
{/if}

<style>
</style>
