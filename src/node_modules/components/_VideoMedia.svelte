<script>
  import { Media, MediaContent } from "@smui/card/styled";
  import Textfield, { Textarea } from "@smui/textfield/styled";
  import { VideoPlayer } from "components/Video";
  import { getExt, getMedia } from "utils";
  import { stores } from "@sapper/app";
  import * as api from 'api';
  import { users } from '../../stores/userStore';
  import { videos } from '../../stores/videoStore';
  import { videoEmitter } from '../../stores/videoEmitter';
  import { _, locale } from 'svelte-i18n';

  export let video = {};
  export let title = "";
  export let description = "";
  export let isEditMode = false;

  const { session } = stores();
  
  let type = getExt(video.src);
  let paused = true;
  let isPlaying;
  let poster = "";
  let src = "";
  let joinData;
  let _video;

  // $: currentUser = $session.user;
  $: currentUser = $users.find(user => user.id == $session.user.id);
  $: token = currentUser.token.token;
  $: isAdmin = $session.role === "Administrator";
  $: joinData =
    currentUser &&
    (_video = currentUser.videos.find((v) => v.id == video.id)) &&
    _video._joinData;
  $: isPlaying = !paused;
  $: (async (id) => {
    if (!id) {
      poster = "";
      return;
    }

    let res = await getMedia("IMAGE", id, $session.user, {
      width: 512,
      height: 512,
      square: 0,
    });
    if (res) poster = res;
  })(video.image_id);
  $: (async (id) => {
    if (!id) return null;
    let res = await getMedia("VIDEO", id, $session.user, { square: 2 });
    if (res) src = res;
  })(video.id);
  $: playhead = isAdmin ? video.playhead : joinData.playhead;

  async function handlePlayhead(e) {
    let playhead = e.detail.playhead;
    if(isAdmin) {
      videoEmitter.dispatch({
        method: 'put',
        data: {...video, playhead},
      });
    } else {
      let id = video.id;
      let associated = currentUser.videos.filter((v) => v.id != video.id).map((v) => ({ id: v.id }));
      let joinData = currentUser.videos.filter((v) => v.id == video.id)[0]._joinData;
      let data = {
        videos: [
          {
            id,
            _joinData: { ...joinData, playhead },
          },
          ...associated,
        ],
      };
      let res = await saveUser(data);
    }
  }

  function saveUser(data) {
    return api.put(`users/${currentUser.id}?lang=${$locale}`, data, token);
  }
</script>

<Media aspectRatio="16x9">
  <MediaContent class="flex" style="display: flex; z-index: 0;">
    <div
      class="text-wrapper bg-gradient-to-b from-black"
      class:isEditMode
      class:is-playing={isPlaying}
    >
      <h2
        class="mdc-typography--headline6 opacity-25"
        class:opacity-25={!video.title}
        style="margin: 0;"
      >
        {video.title || "Here your title"}
      </h2>
      <h3
        class="mdc-typography--subtitle2 opacity-25"
        class:opacity-25={!video.description}
        style="margin: 0;"
      >
        {video.description || "Here your description"}
      </h3>
    </div>
    {#if $session.role === "Administrator"}
      <div class="editor-wrapper" class:is-edit-mode={!isEditMode}>
        <div class="editor">
          <Textfield
            class="mb-4"
            variant="outlined"
            dense
            bind:value={title}
            label="Title"
            input$aria-controls="helper-text-title"
            input$aria-describedby="helper-text-title"
          />
          <Textfield
            textarea
            variant="outlined"
            bind:value={description}
            label="Description"
            input$aria-controls="helper-text-description"
            input$aria-describedby="helper-text-description"
          />
        </div>
      </div>
    {/if}
    <div class="player-container flex flex-1 bg-black">
      <VideoPlayer
        class="video-player flex"
        bind:paused
        on:player:paused={handlePlayhead}
        {poster}
        {src}
        {type}
        {playhead}
      />
    </div>
  </MediaContent>
</Media>

<style>
  .text-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 40%;
    right: inherit;
    z-index: 1;
    transform: translateX(0);
    transform-origin: 0 center;
    transition-property: transform;
    transition-duration: 0.3s;
    transition-timing-function: ease-in-out;
  }
  .text-wrapper,
  .text-wrapper > * {
    pointer-events: none;
  }
  .text-wrapper > * {
    color: var(--text-light);
    padding: 5px 17px;
  }
  .editor-wrapper {
    position: absolute;
    width: 100%;
    height: 100%;
    z-index: 2;
    background: rgba(255, 255, 255, 0.9);
  }
  .editor {
    display: flex;
    flex-direction: column;
    margin: 5px;
  }
  .is-edit-mode {
    display: none;
  }
  .player-container {
    position: relative;
  }
  .is-playing {
    opacity: 0;
    right: 2000px;
    transform: translate(100%);
    transform-origin: 100% center;
    transition-property: opacity, transform;
    transition-duration: 0.1s;
    transition-timing-function: ease-in-out;
  }
</style>
