<script>
  import { Media, MediaContent } from "@smui/card";
  import Textfield, { Textarea } from "@smui/textfield";
  import { VideoPlayer } from "components/Video";
  import { getExt, getMedia } from "utils";
  import { stores } from "@sapper/app";
  import * as api from "api";
  import { users, videoEmitter } from "stores";
  import { _, locale } from "svelte-i18n";
  import { onMount } from "svelte";

  export let video;
  export let title = "";
  export let description = "";
  export let isEditMode = false;

  const { session } = stores();

  let type = getExt(video.src);
  let paused = true;
  let poster = "";
  let src = "";
  let joinData;
  let vid;
  let playhead;
  let canPlay = false;
  let timeoutId;

  $: currentUser = $users.find((user) => user.id == $session.user.id);
  $: token = currentUser.token.token;
  $: isAdmin = $session.role === "Administrator";
  $: joinData =
    currentUser &&
    (vid = currentUser.videos.find((v) => v.id == video.id)) &&
    vid._joinData;
  $: (async (id) => {
    if (!id) {
      poster = "";
      return;
    }
    let res = await getMedia("IMAGE", id, $session.user, {
      width: 512,
      height: 512,
      square: 0,
    });
    if (res) poster = res;
  })(video.image_id);
  $: (async (id) => {
    if (!id) return null;
    let res = await getMedia("VIDEO", id, $session.user, { square: 2 });
    if (res) src = res;
  })(video.id);
  $: ((time) => {
    if (!paused || !canPlay) return;
    let savedTime = time;
    clearTimeout(timeoutId);
    timeoutId = setTimeout(
      (saved) => saved === playhead && savePlayhead(),
      500,
      savedTime
    );
  })(playhead);

  onMount(() => {
    return () => !paused && savePlayhead();
  });

  // set playhead to the last saved position when the video is ready to play
  function handleCanPlay(e) {
    if (canPlay) return;
    canPlay = true;
    playhead = isAdmin ? video.playhead : joinData.playhead;
  }

  function handleEmptied(e) {
    // console.log("Video emptied", e.detail.title);
  }

  function handleLoadStart(e) {
    // console.log("Video load start", e.detail.title);
  }

  function handleLoadedData(e) {
    // console.log("Video loaded data", e.detail.title);
  }

  function handleAborted(e) {
    // in Chrome we have to limit streams do to Chromes limitation
    // this is done by emptying src attribute on the video which forgets the playheads position
    // setting canPlay to false will reset the playhead when video can play again
    canPlay = false;
  }

  async function savePlayhead() {
    if (isAdmin) {
      videoEmitter.dispatch({
        method: "put",
        data: { ...video, playhead },
      });
    } else {
      let joinData,
        data,
        id = video.id,
        vid,
        associated = currentUser.videos
          .filter((v) => v.id != video.id)
          .map((v) => ({ id: v.id }));
      vid = currentUser.videos.find((v) => v.id == video.id);
      if (vid) {
        joinData = vid._joinData;
        data = {
          videos: [
            {
              id,
              _joinData: { ...joinData, playhead },
            },
            ...associated,
          ],
        };
        saveUser(data);
      }
    }
  }

  async function saveUser(data) {
    await api.put(`users/${currentUser.id}?lang=${$locale}`, data, token);
  }
</script>

<Media aspectRatio="16x9">
  <MediaContent class="flex" style="display: flex; z-index: 0;">
    {#if $session.role === "Administrator"}
      <div class="editor-wrapper" class:is-edit-mode={!isEditMode}>
        <div class="editor">
          <Textfield
            class="mb-4"
            variant="outlined"
            dense
            bind:value={title}
            label="Title"
            input$aria-controls="helper-text-title"
            input$aria-describedby="helper-text-title"
          />
          <Textfield
            textarea
            variant="outlined"
            bind:value={description}
            label="Description"
            input$aria-controls="helper-text-description"
            input$aria-describedby="helper-text-description"
          />
        </div>
      </div>
    {/if}
    <div class="player-container flex flex-1 bg-black">
      <VideoPlayer
        class="video-player flex"
        bind:paused
        bind:playhead
        on:player:canplay={handleCanPlay}
        on:player:emptied={handleEmptied}
        on:player:loadeddata={handleLoadedData}
        on:player:loadstart={handleLoadStart}
        on:player:aborted={handleAborted}
        {poster}
        {src}
        {video}
        {type}
      />
    </div>
  </MediaContent>
</Media>

<style>
  .editor-wrapper {
    position: absolute;
    width: 100%;
    height: 100%;
    z-index: 3;
    background: rgba(255, 255, 255, 0.9);
  }
  .editor {
    display: flex;
    flex-direction: column;
    margin: 5px;
  }
  .is-edit-mode {
    display: none;
  }
  .player-container {
    position: relative;
  }
</style>
