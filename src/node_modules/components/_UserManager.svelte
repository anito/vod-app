<script>
  import * as api from 'api';
  import { getContext, onMount, createEventDispatcher } from 'svelte';
  import { goto } from '@sapper/app';
  import { Header } from '@sveltejs/site-kit';
  import { fly } from 'svelte/transition';
  import { stores } from '@sapper/app';
  import { post, getMedia, createRedirectSlug } from 'utils';
  import { users } from '../../stores/userStore';
  import { flash } from '../../stores/flashStore';
  import Textfield from '@smui/textfield';
  import HelperText from '@smui/textfield/helper-text';
  import Button, { Group, Label, Icon } from '@smui/button';
  import FormField from '@smui/form-field';
  import Checkbox from '@smui/checkbox';
  import Switch from '@smui/switch';
  import { Icon as CommonIcon } from '@smui/common';
  import Select, { Option } from '@smui/select';
  import { Icon as SelectIcon } from '@smui/select/icon';
  import { Icon as TextfieldIcon } from '@smui/textfield/icon';
  import Paper, { Title } from '@smui/paper';
  import Menu from '@smui/menu';
  import { Anchor } from '@smui/menu-surface';
  import List, { Item, Separator, Text } from '@smui/list';
  import Component from './_Component.svelte';
  import MediaUploader from './_MediaUploader.svelte';
  import Avatar from './_Avatar.svelte';
  import Dialog, { Title as DialogTitle, Content, Actions, InitialFocus } from '@smui/dialog';

  const { page, session } = stores();
  const { getSnackbar, configSnackbar } = getContext('snackbar');
  const { open } = getContext('simple-modal');

  const actions_table = new Set([
    { action: 'edit', name: 'Benutzer bearbeiten' },
    { action: 'pass', name: 'Passwort bearbeiten' },
    { action: 'del', name: 'Benutzer löschen' },
  ]);
  const admin_actions = ['edit', 'pass', 'del'];
  const user_actions = ['edit'];
  const dispatch = createEventDispatcher();
  const placeholder = 'https://via.placeholder.com/100x100.png?text=';
  const passwordHint = 'Das Passwort muss aus mind. 8 Zeichen bestehen';
  const passwordErrorMesssage = 'Passwörter stimmern nicht überein';
  const invalidEmailMessage = 'Keine gültige Email Adresse.';
  const generateTokenText = 'Token generieren';
  const removeTokenText = 'Token entfernen';
  const copyButtonText = 'Kopieren';
  const copyButtonTexSuccesst = 'Kopiert!';
  const dateOptions = {
    day: '2-digit',
    year: 'numeric',
    month: '2-digit',
    hour: 'numeric',
    minute: 'numeric',
  };

  export let selectionUserId = null;
  export let selectedMode = 'edit';

  let code;
  let root;
  let user = $session.user;
  let groups = $session.groups;
  let filtered;
  let currentUser = {};
  let invalidEmail = false;
  let password = '';
  let repeatedPassword = '';
  let snackbar;
  let message;
  let avatarMenu;
  let avatarMenuAnchor;
  let src = '';
  let token_value = '';
  let token_id = null;
  let token;
  let expires;
  let hasExpired;
  let expirationDate;
  let expiresChipLabel;
  let activeLabel;
  let activeChipLabel;
  let infoDialog;
  let generateTokenDialog;
  let removeTokenDialog;
  let textAreaMagicLink;
  let copyTimeoutId;

  $: currentUser =
    (filtered = ((id) => $users.filter((usr) => usr.id === id))(selectionUserId)) && filtered.length && filtered[0];
  $: userNotFound = selectionUserId && undefined === $users.find((u) => u.id === selectionUserId);
  $: _name = ((usr) => (usr && usr.name) || '')(selectedMode !== 'add' ? currentUser : false);
  $: _active = ((usr) => (usr && usr.active) || false)(selectedMode !== 'add' ? currentUser : false);
  $: _email = ((usr) => (usr && usr.email) || '')(selectedMode !== 'add' ? currentUser : false);
  $: _group_id = ((usr) => (usr && usr.group_id) || '')(selectedMode !== 'add' ? currentUser : false);
  $: invalidPassword = password.length < 8;
  $: invalidRepeatedPassword = password !== repeatedPassword || invalidPassword;
  $: active = _active;
  $: email = _email;
  $: name = _name;
  $: group_id = _group_id;
  $: canSave =
    selectedMode === 'add'
      ? name && group_id && !invalidEmail && !invalidRepeatedPassword
      : active !== _active || name !== _name || group_id != _group_id || (email !== _email && !invalidEmail);
  $: canReset =
    active !== _active || name !== _name || email !== _email || group_id != _group_id || password || repeatedPassword;
  $: (() => resetPassword())(selectionUserId);
  $: (async (usr) => {
    let res,
      avatar = usr.avatar;
    src = defaultAvatar(usr);
    if (avatar) {
      res = await getMedia('AVATAR', avatar.id, user, {
        width: 100,
        height: 100,
        square: 1,
      });
      if (res) src = res;
    }
  })(currentUser);
  $: isAdmin = $session.role === 'Administrator';
  $: actions = isAdmin ? admin_actions : user_actions;
  $: userCan = ((ua) => [...actions_table].filter((s) => ua.find((u) => s.action === u)))(actions);
  $: ((user) => {
    token = user.token;
    expires = user.expires;
    hasExpired = (expires && expires * 1000 < +new Date().getTime()) || false;
    token_id = (token && token.id) || null;
    token_value = (token && token.token) || '';
    expirationDate = (expires && new Date(parseInt(expires) * 1000).toLocaleDateString('de-DE', dateOptions)) || null;
    expiresChipLabel =
      (!token && 'No Token') ||
      (expires && !hasExpired && `Token expires ${expirationDate}`) ||
      (hasExpired && `Token has expired`) ||
      '';
    activeChipLabel = (active && `User is active`) || `User is not active`;
    activeLabel = (active && `Deactivate User`) || `Activate User`;
  })(currentUser);
  $: magicLink = `http://${$page.host}/login?token=${token_value}`;

  onMount(async () => {
    root = document.documentElement;
    root.classList.add('profiledata--open');

    snackbar = getSnackbar();

    if ($page.query && $page.query.action === 'generate:token') {
      const res = await generateToken();
      if (res) {
        $page.query.path && goto($page.query.path);
      }
    }

    return () => {
      root.classList.remove('profiledata--open');
    };
  });

  function defaultAvatar(user) {
    let name = user.name || '?';
    return `${placeholder}${name
      .split(' ')
      .map((val) => val.substring(0, 1))
      .join('')}`;
  }

  let openUploader = () => {
    open(
      MediaUploader,
      {
        type: 'avatar',
        uid: currentUser.id,
        options: {
          parallelUploads: 1,
          maxFiles: 1,
        },
        events: { uploadDone },
      },
      {
        transitionWindow: fly,
        transitionWindowProps: {
          y: -200,
          duration: 500,
        },
      }
    );
  };

  async function uploadDone(e) {
    let detail = e.detail;
    if (detail.success) users.put(detail.data);
    // have we updated the loggedin users avatar?
    // since the loggedin user is in a different store (the session store), put the newly uploaded avatar there
    // this also means we have to persist the new user value(s) in the node server session
    if (user.id === detail.data.id) {
      let config = ['avatar'];
      const res = await post('auth/save', { user: detail.data, config });
      if (res.success) {
        config.map((itm) => ($session.user[itm] = res.data[itm]));
      }
    }
  }

  async function deleteAvatar() {
    const res = await api.del(`avatars/${currentUser.avatar.id}`, user && user.token);
    if (res.success) {
      users.put(res.data);
    }
    if (user.id === currentUser.id) {
      let config = 'avatar';
      const res = await post('auth/save', { user: currentUser, config });
      if (res.success) {
        $session.user[config] = res.data[config];
      }
    }
  }

  async function submit() {
    let res, data, path, action;
    snackbar.isOpen && snackbar.close();

    switch (selectedMode) {
      case 'add':
        data = { active, email, name, password, group_id };
        res = await api.post(`users/add`, data, user && user.token);
        break;
      case 'edit':
        data = { active, email, name, group_id, token };
      case 'pass':
        data = { email, name, group_id, password, token };
        res = await api.put(`users/${selectionUserId}`, data, user && user.token);
        break;
      case 'del':
        if (!confirm(`${name} will be permanently removed. Confirm pressing OK`)) return;
        res = await api.del(`users/${selectionUserId}`, user && user.token);
        break;
    }

    // TODO handle network errors
    message = res.message || res.data.message || res.statusText;
    code = (res.data && res.data.code) || res.status;

    if (res.success) {
      switch (selectedMode) {
        case 'add':
          // fetch users and offer to jump to new user
          const resUsers = await api.get('users', user && user.token);
          if (resUsers.success) {
            users.update(resUsers.data);

            path = `users/${res.data.id}?tab=user`;
            action = 'Goto new user';
            configSnackbar(message, { path, action });
            snackbar.open();
          }
          break;
        case 'pass':
          resetPassword();
        case 'edit':
          users.put({ ...currentUser, ...data });

          configSnackbar(message);
          snackbar.open();
          break;
        case 'del':
          users.del(selectionUserId);
          selectionUserId = null;

          configSnackbar(message, 'users');
          snackbar.open();
      }
    } else if (200 < code && code < 500) {
      // Sample Users are protected
      configSnackbar(message);
      snackbar.open();
    } else {
      flash.update({ type: 'error', message });

      path = `login${createRedirectSlug($page)}`;
      configSnackbar(message, path);
      snackbar.open();
    }
  }

  async function activateUser(e) {
    let data = { active };
    const res = await api.put(`users/${selectionUserId}`, data, user && user.token);

    message = res.message || res.data.message || res.statusText;
    code = (res.data && res.data.code) || res.status;

    if (res) {
      (res.success && users.put({ ...currentUser, ...data })) || (active = !active);
      configSnackbar(message);
      snackbar.open();
    }
  }

  function reset(e) {
    e.preventDefault();
    active = _active;
    email = _email;
    name = _name;
    group_id = _group_id;
    resetPassword();
  }

  function resetPassword() {
    password = repeatedPassword = '';
  }

  async function generateToken() {
    const res = await api.post('tokens', { user_id: currentUser.id }, user.token);

    let message;
    if (res.success) {
      users.put({ ...res.data });
      message = res.message;
      configSnackbar(message);
      snackbar.open();
      return res;
    } else {
      try {
        // validation message
        let message = res.data.errors.token._isUnique || res.data.massage || 'Error';
        configSnackbar(message);
      } catch (e) {}
      snackbar.open();
    }
  }

  async function removeToken() {
    const res = await api.del(`tokens/${token_id}`, user.token);
    if (res.success) {
      users.put({ ...currentUser, ...res.data });
      configSnackbar(res.message);
      snackbar.open();
    } else {
      configSnackbar(res.message);
      snackbar.open();
    }
  }

  function openGenerateTokenDialog(e) {
    generateTokenDialog.open();
  }

  function openRemoveTokenDialog(e) {
    removeTokenDialog.open();
  }

  function openInfoDialog(e) {
    infoDialog.open();
  }

  async function generateTokenDialogCloseHandler(e) {
    if (e.detail.action === 'approved') {
      generateToken();
    }
  }

  async function removeTokenDialogCloseHandler(e) {
    if (e.detail.action === 'approved') {
      removeToken();
    }
  }

  function copyToClipBoard(e) {
    if (textAreaMagicLink) {
      let didCopy,
        inputEl,
        spans,
        target = e.target,
        label = ((spans = target.getElementsByTagName('span')) && spans.length && spans.item(0)) || target;
      inputEl = textAreaMagicLink.getElementsByTagName('input').item(0);
      inputEl.focus();
      inputEl.select();
      didCopy = document.execCommand('copy');
      if (didCopy) {
        label.innerText = copyButtonTexSuccesst;
        clearTimeout(copyTimeoutId);
        copyTimeoutId = setTimeout(() => (label.innerText = copyButtonText), 4000);
      }
    }
  }
</script>

{#if $session.user}
  <div class="grid-item user" style="height: 100%;">
    <Component extended>
      <div slot="header">
        <div class="">
          <Header h="5" mdc>
            <span>
              {#if currentUser}
                {currentUser.name}
              {:else if selectedMode === 'add'}Neuen Klienten anlegen{/if}
            </span>
          </Header>
          <button on:click={() => goto('users')} class="button-close" variant="outlined">
            <Icon class="material-icons" style="vertical-align: middle;">close</Icon>
          </button>
        </div>
      </div>
      <div class="flex flex-shrink">
        {#if userNotFound}
          <div class="exception user-not-found">
            <Paper color="primary">
              <Title style="color: var(--text-light)">Benutzer wurde nicht gefunden</Title>
            </Paper>
          </div>
        {:else}
          {#if selectionUserId}
            <div class="avatar-container" on:click={() => avatarMenu.setOpen(true)}>
              <div bind:this={avatarMenuAnchor} use:Anchor>
                <Avatar {src} size="lg" />
                <Menu
                  bind:this={avatarMenu}
                  anchor={false}
                  bind:anchorElement={avatarMenuAnchor}
                  anchorCorner="TOP_END"
                >
                  <List>
                    <Item on:click={() => openUploader()}>
                      <Text>Avatar ändern</Text>
                    </Item>
                    <Item disabled={!currentUser.avatar} on:click={() => deleteAvatar()}>
                      <Text>Avatar löschen</Text>
                    </Item>
                  </List>
                </Menu>
              </div>
            </div>
          {/if}
          <form on:submit|preventDefault={submit} method="post" class="table">
            <div class="user-items">
              {#if selectedMode !== 'add'}
                <div class="flex justify-between flex-wrap">
                  <div class="select-item item">
                    <Select
                      enhanced
                      bind:value={selectedMode}
                      label="Select Mode"
                      class="select-width"
                      menu$class="select-width"
                      variant="filled"
                    >
                      <Option value="" />
                      {#each userCan as can}
                        <Option value={can.action} selected={selectedMode === can.action}>
                          {can.name}
                        </Option>
                      {/each}
                    </Select>
                  </div>
                  {#if isAdmin && selectedMode === 'edit'}
                    <div class="item">
                      <div class="ml-3" style="flex: 0.5;">
                        <FormField>
                          <Switch bind:checked={active} on:change={(e) => activateUser(e)} />
                          <span slot="label">{activeLabel}</span>
                        </FormField>
                      </div>
                    </div>
                  {/if}
                </div>
              {/if}
              {#if selectedMode === 'add' || selectedMode === 'edit'}
                <div class="item">
                  <Textfield
                    class="w-full"
                    bind:value={email}
                    bind:invalid={invalidEmail}
                    label=""
                    type="email"
                    updateInvalid
                    input$autocomplete="email"
                  >
                    <span slot="label"
                      ><CommonIcon
                        class="material-icons"
                        style="font-size: 1em; line-height: normal; vertical-align: middle;">email</CommonIcon
                      >
                      Email</span
                    >
                  </Textfield>
                  <HelperText validationMsg>{invalidEmailMessage}</HelperText>
                </div>
                <div class="item">
                  <Textfield
                    withLeadingIcon
                    bind:value={name}
                    label="Name"
                    type="text"
                    input$aria-controls="helper-text-standard-b"
                    input$aria-describedby="helper-text-standard-b"
                  >
                    <TextfieldIcon class="material-icons">contact_page</TextfieldIcon>
                  </Textfield>
                  <HelperText id="helper-text-standard-b">Ihr Name</HelperText>
                </div>
                <div class="item">
                  <Select
                    disabled={!isAdmin}
                    withLeadingIcon
                    bind:value={group_id}
                    label="Benutzerrolle"
                    class="select-width"
                    menu$class="select-width"
                  >
                    <span slot="icon"><SelectIcon class="material-icons">contact_page</SelectIcon></span>
                    <Option value="" />
                    {#each groups as group}
                      <Option value={group.id} selected={group_id === group.id}>
                        {group.name}
                      </Option>
                    {/each}
                  </Select>
                </div>
              {/if}
              {#if selectedMode === 'add' || selectedMode === 'pass'}
                <div class="item">
                  <Textfield
                    withLeadingIcon
                    type="password"
                    bind:invalid={invalidPassword}
                    bind:value={password}
                    label="Passwort"
                    input$aria-controls="helper-password"
                    input$aria-describedby="helper-password"
                    style="min-width: 250px;"
                  >
                    <TextfieldIcon class="material-icons">fingerprint</TextfieldIcon>
                  </Textfield>
                  <HelperText id="helper-password">{passwordHint}</HelperText>
                </div>
                <div class="item">
                  <Textfield
                    withLeadingIcon
                    type="password"
                    disabled={invalidPassword}
                    bind:invalid={invalidRepeatedPassword}
                    class=""
                    bind:value={repeatedPassword}
                    label="Passwort wiederholen"
                    input$aria-controls="helper-password-repeat"
                    input$aria-describedby="helper-password-repeat"
                  >
                    <TextfieldIcon class="material-icons">fingerprint</TextfieldIcon>
                  </Textfield>
                  <HelperText id="helper-password-repeat">
                    {passwordErrorMesssage}
                  </HelperText>
                </div>
              {/if}
              {#if selectedMode === 'add' || selectedMode === 'edit' || selectedMode === 'pass'}
                <div class="item">
                  <div class="button-group">
                    <Group>
                      {#if selectedMode !== 'pass'}
                        <Button disabled={!canSave} color="primary" variant="unelevated">
                          <Label>Speichern</Label>
                          <CommonIcon class="material-icons">save</CommonIcon>
                        </Button>
                      {:else}
                        <Button disabled={invalidRepeatedPassword} color="primary" variant="unelevated">
                          <Label>Speichern</Label>
                          <CommonIcon class="material-icons">fingerprint</CommonIcon>
                        </Button>
                      {/if}
                      <Button disabled={!canReset} color="primary" on:click={reset} variant="unelevated">
                        <Label>Zurücksetzen</Label>
                        <CommonIcon class="material-icons">settings_backup_restore</CommonIcon>
                      </Button>
                    </Group>
                  </div>
                </div>
              {/if}
              {#if selectedMode === 'del'}
                <div class="item">
                  <div class="alert" role="alert">
                    <div class="bg-red-500 text-white font-bold rounded-t px-4 py-2">Achtung!</div>
                    <div class="border border-t-0 border-red-400 rounded-b bg-red-100 px-4 py-3 text-red-700">
                      <p>Dieser Vorgang kann nicht rückgängig gemacht werden!</p>
                    </div>
                  </div>
                  <Button color="primary" variant="unelevated">
                    <Label>Alles klar, endgültig löschen</Label>
                    <CommonIcon class="material-icons">delete</CommonIcon>
                  </Button>
                </div>
              {/if}
              {#if !selectedMode}
                <div class="exception no-selection">
                  <Paper color="primary">
                    <Title style="color: var(--text-light)">
                      Select Edit Mode
                      {selectedMode}
                    </Title>
                  </Paper>
                </div>
              {/if}
            </div>
          </form>
        {/if}
        {#if currentUser && isAdmin}
          <div class="token-factory table" class:has-magic-link={!!token_id}>
            <div class="main-info">
              <div class="button-group token-action-buttons flex mt-1 mb-3">
                <Group>
                  <Button
                    class="magic-link"
                    variant="raised"
                    on:click={() => (!token_id && generateToken()) || openGenerateTokenDialog()}
                  >
                    <CommonIcon class="material-icons">link</CommonIcon>
                    <Label class="token-button-label">
                      {generateTokenText}
                    </Label>
                  </Button>
                  <Button
                    disabled={currentUser.group.name === 'Administrator' || !token_id || currentUser.protected}
                    label="Administratoren können nicht gesperrt werden"
                    variant="raised"
                    on:click={() => openRemoveTokenDialog()}
                  >
                    <Label class="token-button-label">{removeTokenText}</Label>
                  </Button>
                </Group>
              </div>
              <div class="item">
                <span>
                  <i class="material-icons mdc-button__icon">info</i>
                  <a href="." class="item" on:click|preventDefault={() => openInfoDialog()}>
                    Wie funktioniert der Token?
                  </a>
                </span>
              </div>
              <div class="item chip-items flex">
                <div class="expires-label chip" class:has-expired={hasExpired} class:no-token={!token}>
                  <i class="material-icons mdc-button__icon mr-1"
                    >{((hasExpired || !token) && 'announcement') || 'done'}</i
                  >
                  {expiresChipLabel}
                </div>
                <div class="active-label chip" class:is-not-active={!active}>
                  <i class="material-icons mdc-button__icon mr-1">{(!active && 'announcement') || 'done'}</i>
                  {activeChipLabel}
                </div>
              </div>
              <div class="item">
                {#if token}
                  <div class="button-group magic-link-group token-action-buttons flex">
                    <Group style="max-width: 100%;">
                      <Button on:click={() => dispatch('openRedirectToUserDialog')} variant="outlined">
                        <Icon class="material-icons">link</Icon>
                        <Label class="token-button-label">Magic Link</Label>
                      </Button>
                      <Button use={[(node) => (textAreaMagicLink = node)]} disabled={!token_id} variant="outlined">
                        <input style="width: 100%;" type="text" value={magicLink} />
                      </Button>
                      <Button disabled={!token_id} variant="unelevated" on:click={(e) => copyToClipBoard(e)}>
                        <Label class="token-button-label">
                          {copyButtonText}
                        </Label>
                      </Button>
                    </Group>
                  </div>
                {/if}
              </div>
            </div>
            <div class="additional-info">
              {#if token}
                <div class="item">
                  <h5 class="mb-4">Weitere Schritte</h5>
                  <details>
                    <summary>Den Magic Link testen</summary>
                    <p>
                      Testen Sie den Magic Link indem Sie auf den Button
                      <i>Magic Link</i>
                      klicken. Sie werden von Ihrem Account abgemeldet und automatisch als
                      <strong>{currentUser.name}</strong>
                      angemeldet. Um später als
                      <strong>{$session.user.name}</strong>
                      weiter zu arbeiten, müssen Sie sich erneut als diese(r) anmelden.
                    </p>
                  </details>
                  <details>
                    <summary>Link verschicken</summary>
                    <p>
                      Je nach Konfiguration Ihres Browsers, startet bei Anklicken spezieller Email-Links ein Email
                      Programm. Falls dies bei Ihnen nicht der Fall sein sollte, lesen Sie den nächsten Punkt.
                      <br />
                      Öffnet (eventuell) ein Email Programm:
                      <a
                        href="mailto:{currentUser.email}?subject=Ihr Zugangslink zu Ihren Online-Kursen&body=http://{$page.host}/login?token={token_value}&cc={user.email}"
                        target="_blank"
                      >
                        per Email an
                        {currentUser.name}</a
                      >
                    </p>
                  </details>
                  <details>
                    <summary>Link kopieren</summary>
                    <p>
                      Benutzen Sie den Button
                      <i>Kopieren</i>
                      um den Link in Ihrer Zwischenablage zu speichern. Sie können den Link anschliessend über den
                      <i>Einfügen</i>-Befehl (<i>Strg-V</i>) in eine Email einfügen und weiterleiten.
                    </p>
                  </details>
                </div>
              {/if}
            </div>
          </div>
        {/if}
      </div>
    </Component>
  </div>
{/if}
<Dialog bind:this={infoDialog} aria-labelledby="info-title" aria-describedby="info-content">
  <DialogTitle id="info-title">Was ist ein Token?</DialogTitle>
  <Content id="info-content">
    <div class="item">
      <i class="material-icons mdc-button__icon">info</i>
      Ein Token ist eine kryptische Zeichenkette mit verschlüsselten (Anmelde-) Informationen.<br />Beispiel:

      <pre>
        eyJ0eXAiiJKV1QiLCJhbGciOiJIUzI1NiJ9.as...
      </pre>
    </div>
    <div class="item">
      <details>
        <summary>Wofür wird der Token verwendet?</summary>
        <p>
          Der Token wird als Parameter an einen Link "angehängt". Kann der Zielserver den Token entschlüsseln und einem
          vorhandenen Benutzer zuordnen, wird dieser Benutzer angemeldet. Das übliche fehlerbehaftete Eintippen von
          Benutzernamen/Passwort entfällt also und es kann sofort losgelegt werden.
        </p>
      </details>
      <details>
        <summary>Wie gehe ich weiter vor?</summary>
        <p>
          Benutzen Sie den Button
          <i>"{generateTokenText}"</i>, um einen
          <i>magischen Link</i>
          zu erzeugen. Dadurch wird auch automatisch der Account freigeschaltet. Um Ihren KlientInnen Zugang zu ihrem Account
          zu ermöglichen, müssen Sie nur noch den Link an sie aushändigen.
        </p>
      </details>
      <details>
        <summary>Was tun bei Verdacht auf Missbrauch des Tokens?</summary>
        <p>
          Generieren Sie in diesem Fall über den Button
          <i>"{generateTokenText}"</i>
          einen neuen Token. Alle zuvor generierten Token werden dadurch unbrauchbar.
        </p>
        <p>
          Verwenden Sie den Button
          <i>"{removeTokenText}"</i>, um das Konto zu sperren. Alternativ können Sie auch
          <i>Deactivate User</i>
          anklicken. Beachten Sie hier jedoch, dass dann auch das Einloggen über Email/Passwort nicht mehr möglich ist.
        </p>
      </details>
    </div>
    <div class="item">
      <i class="material-icons mdc-button__icon">info</i>
      Benutzen Sie den Button
      <i>{removeTokenText}</i>
      um die Anmeldung über diesen Link zu verhindern. Sie können jederzeit einen neuen Token generieren.
    </div>
    <div class="item">
      <i class="material-icons mdc-button__icon">warning</i>
      Jeder im Besitz dieses Links verfügt automatisch über Zugriff auf gespeicherte Benutzerdaten, einschliesslich gebuchter
      Inhalte. Gehen Sie daher äusserst achtsam mit dem Token bzw. Link um und geben Sie ihn nicht an Dritte weiter.
    </div>
    <div class="item">
      Die Gültigkeit des Tokens richtet sich jeweils nach dem Buchungsende des spätesten Videos. Falls gerade keine
      Videos gebucht sind, aber dennoch ein neuer Token angefordert wird, hat dieser eine Gültigkeit von 30 Tagen.
    </div>
  </Content>
  <Actions>
    <Button action="approved" default use={[InitialFocus]}>
      <Label>Schliessen</Label>
    </Button>
  </Actions>
</Dialog>
<Dialog
  bind:this={generateTokenDialog}
  aria-labelledby="info-title"
  aria-describedby="info-content"
  on:MDCDialog:closed={generateTokenDialogCloseHandler}
>
  <DialogTitle id="info-title">Neuer Token</DialogTitle>
  <Content id="info-content">
    <i class="material-icons mdc-button__icon">warning</i>
    <div class="item">
      <p>Der vorherige Token wird dadurch unbrauchbar!</p>
      <p>
        Denken Sie daran, dem Nutzer
        <strong>{currentUser.name}</strong>
        den Token zu übermitteln.
      </p>
    </div>
  </Content>
  <Actions>
    <Button action="none">
      <Label>Abbrechen</Label>
    </Button>
    <Button action="approved" default use={[InitialFocus]}>
      <Label>Neuen Token generieren</Label>
    </Button>
  </Actions>
</Dialog>
<Dialog
  bind:this={removeTokenDialog}
  aria-labelledby="info-title"
  aria-describedby="info-content"
  on:MDCDialog:closed={removeTokenDialogCloseHandler}
>
  <DialogTitle id="info-title">Token löschen und Account sperren</DialogTitle>
  <Content id="info-content">
    <div class="item">Mit dieser Aktion wird der bisherige Token gelöscht und der Account gesperrt.</div>
    <div class="item">
      <i class="material-icons mdc-button__icon">warning</i>
      Beachten Sie, dass danach auch keine Anmeldung mehr über
      <i>Benutzername/Passwort</i>
      möglich sein wird!
    </div>
  </Content>
  <Actions>
    <Button action="none">
      <Label>Abbrechen</Label>
    </Button>
    <Button action="approved" default use={[InitialFocus]}>
      <Label>Token löschen & Account sperren</Label>
    </Button>
  </Actions>
</Dialog>

<style>
  form {
    position: relative;
    flex: 1;
  }
  .grid-item {
    background: var(--back-grid-item);
  }
  .user {
    grid-area: one;
    overflow: auto;
  }
  .user-items {
    display: flex;
    flex-direction: column;
  }
  .item {
    margin-bottom: 1.5rem;
  }
  :global(.item > label) {
    width: 100%;
  }
  .exception {
    display: flex;
    text-align: center;
    flex: 1 0 0%;
    justify-content: center;
  }
  .alert {
    display: table;
    margin-bottom: 1em;
  }
  .avatar-container {
    display: flex;
    justify-content: flex-end;
    position: absolute;
    right: 50px;
    top: 20px;
    z-index: 1;
  }
  .avatar-container :global(img) {
    cursor: pointer;
  }
  .token-factory {
    flex: 1;
    overflow: auto;
    background: #fff;
    border: 1px solid #dcdcdc;
    margin-left: 3rem;
    padding: 20px;
    border-radius: 2px;
  }
  .token-factory > * {
    padding: 50px;
  }
  .token-factory > *:nth-child(1) {
    padding-bottom: 0;
  }
  .token-factory > *:nth-child(2) {
    padding-top: 0;
  }
  .token-factory :global(button.magic-link) {
    --mdc-theme-primary: var(--warning);
  }
  .token-factory.has-magic-link :global(button.magic-link) {
    --mdc-theme-primary: var(--flash);
  }
  .token-factory .additional-info {
    overflow: auto;
  }
  .item :global(.material-icons.mdc-button__icon) {
    vertical-align: middle;
  }
  .token-factory .item {
    font-size: 0.8rem;
  }
  .token-action-buttons :global(.token-button-label) {
    font-size: 0.6rem;
    max-width: 130px;
  }
  .button-group :global(.smui-button__group) {
    flex: 1;
  }
  .button-group :global(button) {
    flex: 1;
  }
  .magic-link-group > :global(.smui-button__group > button:nth-child(1)) {
    flex: 0 1 150px;
  }
  .magic-link-group > :global(.smui-button__group > button:nth-child(2)) {
    flex: 1;
    text-transform: unset;
    font-size: 0.5rem;
    display: inline;
  }
  .magic-link-group > :global(.smui-button__group > button:nth-child(3)) {
    flex: 0 1 100px;
  }
  pre {
    overflow: auto;
    padding: 1.5rem 2rem;
    margin: 0.8rem 0 2.4rem;
    /* max-width: var(--code-w); */
    border-radius: var(--border-r);
    box-shadow: 1px 1px 1px rgba(68, 68, 68, 0.12) inset;
    background: var(--background);
  }
  .button-close {
    display: none;
  }
  .chip {
    border-radius: 999px;
    background-color: #e0e0e0;
    font-family: Roboto, sans-serif;
    -moz-osx-font-smoothing: grayscale;
    -webkit-font-smoothing: antialiased;
    font-size: 0.8rem;
    line-height: 1.25rem;
    margin-right: 5px;
    font-weight: 400;
    letter-spacing: 0.01786em;
    text-decoration: inherit;
    text-transform: inherit;
    height: auto;
    position: relative;
    text-overflow: ellipsis;
    align-items: center;
    white-space: nowrap;
    box-sizing: border-box;
    padding: 7px 12px;
    border-width: 0;
    outline: none;
    cursor: pointer;
    -webkit-appearance: none;
    overflow: hidden;
  }
  .chip .material-icons {
    font-size: 1rem;
  }
  .chip.has-expired,
  .chip.is-not-active,
  .chip.no-token {
    background-color: var(--warning);
    color: #fff;
  }
  :global(.add-user-view--open) .button-close {
    display: block;
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translate(50%, -50%);
  }
</style>
