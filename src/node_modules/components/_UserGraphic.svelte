<script>
  import { stores } from '@sapper/app';
  import { Graphic } from '@smui/list/styled';
  import { Icon } from '@smui/common/styled';
  import { getMedia } from 'utils/media';

  export let user = {};
  export let dense = '';
  export let width = 24;
  export let height = 24;
  export let border = '';
  export let badge = {};

  const { session } = stores();
  const placeholder =
    'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJFYmVuZV8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB2aWV3Qm94PSIwIDAgODUuMSA4NSIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgODUuMSA4NTsiIHhtbDpzcGFjZT0icHJlc2VydmUiPgo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgoJLnN0MHtmaWxsOiM4QzFGNzY7fQo8L3N0eWxlPgo8Zz4KCTxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik00Mi41LDQyLjVjMTEuNywwLDIxLjMtOS41LDIxLjMtMjEuM1M1NC4zLDAsNDIuNSwwUzIxLjIsOS41LDIxLjIsMjEuM1MzMC44LDQyLjUsNDIuNSw0Mi41eiBNNDIuNSw1My4xCgkJQzI4LjMsNTMuMSwwLDYwLjIsMCw3NC40Vjg1aDg1LjFWNzQuNEM4NS4xLDYwLjMsNTYuNyw1My4xLDQyLjUsNTMuMXoiLz4KPC9nPgo8L3N2Zz4K';

  let src = '';

  $: (async (usr) => {
    let res,
      avatar = usr && usr.avatar;

    if (avatar) {
      res = await getMedia('AVATAR', avatar.id, $session.user, {
        width,
        height,
        square: 1,
      });
      if (res) {
        src = res;
      } else {
        src = defaultAvatar(usr) || placeholder;
      }
    } else {
      src = placeholder;
    }
  })(user);

  function defaultAvatar(user) {
    let name = user.name;
    if (name) return false;
    return `${placeholder}${name
      .split(' ')
      .map((val) => val.substring(0, 1))
      .join('')}`;
  }
</script>

<div class="user-graphics-outer" class:dense class:graphics-border={!!border}>
  <Graphic
    class="user-graphics"
    style="background-image: url({src}); display: inline-flex; vertical-align: middle; width: {width}px; height: {height}px; box-shadow: {border}"
  />
  {#if badge.icon}
    <div class="badge">
      <Icon style="color:{badge.color}" class="material-icons">{badge.icon}</Icon>
    </div>
  {/if}
</div>

<style>
  .user-graphics-outer {
    display: inline-block;
    position: relative;
  }
  .user-graphics-outer :global(.user-graphics) {
    border-radius: 50%;
  }
  .user-graphics-outer.dense :global(.user-graphics) {
    margin-right: 0;
  }
  .user-graphics-outer.graphics-border :global(.user-graphics) {
    box-shadow: 0 0px 0px 1px #c5c5c5;
  }
  .badge {
    position: absolute;
    width: 14px;
    height: 14px;
    right: 12px;
    top: -5px;
  }
  .badge :global(.material-icons) {
    font-size: 1.1em;
  }
</style>
