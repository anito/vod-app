<script>
  import { stores } from "@sapper/app";
  import { Graphic } from "@smui/list";
  import { Icon } from "@smui/common";
  import { getMedia, svg } from "utils";
  import { theme } from "stores/themeStore";
  
  export let user = {};
  export let dense = "";
  export let width = 24;
  export let height = 24;
  export let border = "";
  export let badge = {};

  const { session } = stores();

  $: src = placeholder('person', [$theme.primary]);
  $: (async (usr) => {
    let res,
      avatar = usr && usr.avatar,
      googleAvatar;

    googleAvatar =
      (avatar && avatar.src && avatar.src.startsWith("http") && avatar.src) ||
      "";
    if (googleAvatar) {
      src = googleAvatar;
    } else if (avatar) {
      res = await getMedia("AVATAR", avatar.id, $session.user, {
        width,
        height,
        square: 1,
        quality: 100,
      });
      if (res) {
        src = res;
      }
    } else {
      src = placeholder('person', [$theme.primary]);
    }
  })(user);

  function placeholder(name, colors) {
    return (
      "data:image/svg+xml;utf8," +
      svg[name].apply(
        null,
        ((c) => {
          for (var fillColors = [], i = 0; i < c.length; i++) {
            fillColors.push(c[i].replace('#', '%23'));
          }
          return fillColors;
        })(colors)
      )
    );
  }
</script>

<div class="user-graphics-outer" class:dense class:graphics-border={!!border}>
  <Graphic
    class="user-graphics"
    style="display: inline-flex; vertical-align: middle; width: {width}px; height: {height}px; box-shadow: {border}; background-image: url('{src}'); background-size: cover;"
  />
  {#if badge.icon}
    <div class="badge">
      <Icon style="color:{badge.color}" class="material-icons"
        >{badge.icon}</Icon
      >
    </div>
  {/if}
</div>

<style>
  .user-graphics-outer {
    display: inline-block;
    position: relative;
  }
  .user-graphics-outer :global(.user-graphics) {
    border-radius: 50%;
  }
  .user-graphics-outer.dense :global(.user-graphics) {
    margin-right: 0;
  }
  .user-graphics-outer.graphics-border :global(.user-graphics) {
    box-shadow: 0 0px 0px 1px #c5c5c5;
  }
  .badge {
    position: absolute;
    width: 14px;
    height: 14px;
    right: 12px;
    top: -5px;
  }
  .badge :global(.material-icons) {
    font-size: 1.1em;
  }
</style>
