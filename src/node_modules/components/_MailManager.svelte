<script>
  import './drawer.scss';
  import * as api from 'api';
  import { onMount, getContext } from 'svelte';
  import { get } from 'svelte/store';
  import { stores, goto } from '@sapper/app';
  import { fabs } from '../../stores/fabStore';
  import { users } from '../../stores/userStore';
  import { sents } from '../../stores/sentStore';
  import { inboxes } from '../../stores/inboxStore';
  import { templates } from '../../stores/templateStore';
  import { slugify, locationSearch } from 'utils';
  import MailViewer from './_MailViewer.svelte';
  import MailList from './_MailList.svelte';
  import MailToolbar from './_MailToolbar.svelte';
  import MailTemplateToolbar from './_MailTemplateToolbar.svelte';
  import MailTemplate from './_MailTemplate.svelte';
  import Badge from './_Badge.svelte';
  import BadgeGroup from './_BadgeGroup.svelte';
  import { _ } from 'svelte-i18n';
  import Drawer, { AppContent, Content, Header, Title, Subtitle, Scrim } from '@smui/drawer';
  import Button, { Group, Icon } from '@smui/button';
  import IconButton from '@smui/icon-button';
  import List, { Item, Text, Graphic, Separator, Subheader, Meta } from '@smui/list';
  import Fab, { Label, Icon as FabIcon } from '@smui/fab';
  import Dialog, { Title as DialogTitle, Content as DialogContent, Actions, InitialFocus } from '@smui/dialog';
  import H6 from '@smui/common/H6.svelte';

  export let selectionUserId = null;

  const { page, session } = stores();
  const { getSnackbar, configSnackbar } = getContext('snackbar');
  const { setFab } = getContext('fab');
  const sortAZ = (a, b) => (a.name > b.name ? 1 : a.name < b.name ? -1 : 0);
  const slugValidation = ['magic-link'];

  let drawer;
  let snackbar;
  let drawerOpen = true;
  let selected;
  let unreadInboxes = 0;
  let sort = 'DESC';
  let create = false;
  let root;
  let canSave;
  let working;
  let templateComponent;
  let unsavedChangesDialog;
  let editable;
  let editor = {};
  let pendingActiveTemplate;
  let defaultActive = 'inboxes';
  let active;
  let selectionIndex;

  $: currentUser = ((id) => get(users).filter((usr) => usr.id === id))(selectionUserId)[0];
  $: selectionUserId && (selectionIndex = -1);
  $: username = currentUser && currentUser.name;
  $: totalMails = currentUser && $sents.length;
  $: totalInboxes = currentUser && $inboxes.length;
  $: unreadInboxes = currentUser && $inboxes.filter((mail) => !mail.read).length;
  $: email = currentUser && currentUser.email;
  $: currentUser && getInbox(currentUser);
  $: currentUser && getSent(currentUser);
  $: $page.query.active && setActiveList($page.query.active);
  $: create = templateMatch(active);
  $: create ? setFab('send-mail') : setFab('add-user');
  $: currentTemplate = $templates.find((tmpl) => tmpl.slug === templateMatch(active)) || null;
  $: currentStore = active === 'inboxes' ? inboxes : active === 'sents' ? sents : null;
  $: activePath = (active) =>
    `${$page.path}${locationSearch({
      ...$page,
      query: { ...$page.query, active },
    })}`;
  $: templateData =
    currentTemplate &&
    ((slug) => {
      switch (slug) {
        case 'magic-link':
          if (!currentUser.token) return false;
          if (!isValidToken()) return false;
          return `http://${$page.host}/login?token=${currentUser && currentUser.token.token}`;
        default:
          return false;
      }
    })(currentTemplate.slug);
  $: invalidSlug =
    (currentTemplate &&
      slugValidation.find((slug) => slug === currentTemplate.slug) &&
      !templateData &&
      currentTemplate.slug) ||
    false;

  onMount(() => {
    root = document.documentElement;
    root.classList.add('mailmanager--open');

    snackbar = getSnackbar();
    getTemplates();

    !$page.query.active && gotoActive(defaultActive);

    return () => {
      root.classList.remove('mailmanager--open');
    };
  });

  async function sendMail() {
    const res = await api.post(
      'sents/add/',
      { email: currentUser.email, ...working, template: { slug: currentTemplate.slug, data: templateData } },
      $session.user && $session.user.token
    );
    if (res.success) {
      configSnackbar($_('text.message-sent-success'));
      reloadMails();
    } else {
      configSnackbar($_('text.message-sent-failed'));
    }
    snackbar.open();
  }

  async function getInbox(user) {
    let items = [],
      _users;
    const res = await api.get(`inboxes/get/${user.id}`, $session.user && $session.user.token);
    if (res.success) {
      res.data.map((mail) => {
        let message = JSON.parse(mail.message);
        items.push({
          id: mail.id,
          from: (_users = $users.filter((user) => user.email === mail._from)) && _users.length ? _users : [mail._from],
          to: [user],
          message: message.message,
          subject: message.subject,
          read: mail._read,
          created: mail.created,
        });
      });
      inboxes.update(items);
    }
  }

  async function getSent(user) {
    let items = [],
      _users;
    const res = await api.get(`sents/get/${user.id}`, $session.user && $session.user.token);
    if (res.success) {
      let _to;
      res.data.map((mail) => {
        let message = JSON.parse(mail.message);
        _to = mail._to.split(';');
        items.push({
          id: mail.id,
          from: [user],
          to: (_users = $users.filter((user) => _to.find((adr) => adr === user.email))) && _users.length ? _users : _to,
          message: message.message,
          subject: message.subject,
          read: true,
          created: mail.created,
        });
      });
      sents.update(items);
    }
  }

  function setActiveList(value) {
    let template = templateMatch(value);

    if (template && active != value && canSave) {
      pendingActiveTemplate = value;
      unsavedChangesDialog.open();
    } else {
      active = value;
    }
  }

  async function toggleRead(e) {
    let _selected, _read;
    _selected = e && e.detail.selected;
    _read = e && e.detail.read != void 0 ? e.detail.read : !_selected.read;
    const res = await api.put(`inboxes/${_selected.id}`, { _read }, $session.user && $session.user.token);
    if (res.success) {
      selected = { ..._selected, read: _read };
      inboxes.put(selected);
    }
  }

  async function deleteMail(e) {
    let _selected = e.detail.selected;
    const res = await api.del(`${active}/${_selected.id}`, $session.user && $session.user.token);
    if (res.success) {
      currentStore.del(_selected.id);
    }
  }

  function reloadMails() {
    currentUser = currentUser;
  }

  function toggleSortByDate() {
    sort = sort === 'DESC' ? 'ASC' : 'DESC';
  }

  async function getTemplates() {
    const res = await api.get('templates', $session.user && $session.user.token);
    if (res.success) {
      templates.update(res.data);
    }
  }

  function resetTemplate() {
    templateComponent.resetTemplate();
  }

  async function addTemplate() {
    if (!$templates.length) return;
    let { name, slug } = generateName();
    let items = [];
    let template = $templates[0];
    template.items.map((item) => {
      items.push({
        content: '',
        field_id: item.field.id,
        field: item.field,
      });
    });
    let newTemplate = { name, slug, items };
    const res = await api.post('templates', { ...newTemplate }, $session.user && $session.user.token);
    if (res.success) {
      configSnackbar($_('text.template-created'));
      templates.add({ ...newTemplate, id: res.data.id, items: res.data.items });
      gotoActive(templateStringFromSlug(slug));
    } else {
      configSnackbar($_('text.template-create-failed'));
    }
    snackbar.open();
  }

  async function saveTemplate() {
    let items = [];
    currentTemplate.items.map((item) => {
      let content = working[item.field.name];
      item.content = content;
      items.push({ id: item.id, content });
    });
    const res = await api.put(`templates/${currentTemplate.id}`, { items }, $session.user && $session.user.token);
    if (res.success) {
      configSnackbar($_('text.template-saved'));
      templates.put({ ...currentTemplate });
      templateComponent.createWorkingCopy();
    } else {
      configSnackbar($_('text.template-save-failed'));
    }
    snackbar.open();
  }

  async function duplicateTemplate() {
    let { name, slug } = generateName(currentTemplate.name);
    let items = [];
    currentTemplate.items.map((item) => {
      items.push({
        content: working[item.field.name],
        field_id: item.field.id,
        field: item.field,
      });
    });
    let newTemplate = { name, slug, items };
    const res = await api.post('templates', { ...newTemplate }, $session.user && $session.user.token);
    if (res.success) {
      configSnackbar($_('text.template-duplicated'));
      templates.add({ ...newTemplate, id: res.data.id, items: res.data.items });
      gotoActive(templateStringFromSlug(slug));
    } else {
      configSnackbar($_('text.template-duplicated-failed'));
    }
    snackbar.open();
  }

  async function removeTemplate() {
    const res = await api.del(`templates/${currentTemplate.id}`, $session.user && $session.user.token);
    if (res.success) {
      configSnackbar($_('text.template-removed'));
      templates.del(currentTemplate.id);
    } else {
      configSnackbar($_('text.template-could-not-be-removed'));
    }
    snackbar.open();
  }

  function unsavedChangesDialogCloseHandler(e) {
    if (e.detail.action === 'discard') {
      pendingActiveTemplate && (active = pendingActiveTemplate);
      pendingActiveTemplate = void 0;
    }
  }

  function hoverEditable(e) {
    editable = e.currentTarget;
    editable && editable.classList.add('hover');
  }

  function leaveEditable(e) {
    if (editable && editable.getElementsByClassName('editor').length) return;
    editable && editable.classList.remove('hover');
  }

  function makeEditable(e, id) {
    e.preventDefault();
    e.stopPropagation();
    let range = document.createRange();
    let selection = window.getSelection();
    let children = editable.getElementsByClassName('editable');
    let node = children.length && children[0];

    editor.node && editor.node.classList.remove('editor');

    editor = { id, node, value: node.innerText, editable };
    editor.node.classList.add('editor');
    editor.node.setAttribute('contenteditable', 'true');
    editor.node.addEventListener('keydown', keyListener);
    editor.node.addEventListener('click', ignoreClick);
    editor.node.focus();
    range.selectNodeContents(editor.node);
    range.collapse(false);
    selection.removeAllRanges();
    selection.addRange(range);
  }

  function keyListener(e) {
    e.stopPropagation();
    // console.log('code', e.code);
    // console.log('key', e.key);
    // console.log('keyCode', e.keyCode);

    const isEnter = e.key === 'Enter' || e.keyCode === 13;
    const isEscape = e.key === 'Escape' || e.keyCode === 27;
    if (isEnter) {
      saveEditable(e);
    }
    if (isEscape) {
      cancelEditable(e);
    }
  }

  function ignoreClick(e) {
    e.stopPropagation();
    e.preventDefault();
  }

  async function saveEditable(e) {
    let success;
    e.preventDefault();
    editor.node.classList.remove('editor');
    editor.node.setAttribute('contenteditable', 'false');
    editor.node.removeEventListener('keydown', keyListener);
    editor.node.removeEventListener('click', ignoreClick);
    editor.editable.classList.remove('hover');
    if (editor.value !== editor.node.innerText) {
      success = await saveTemplateName(editor.node.innerText, editor.id);
      !success && (editor.node.innerText = editor.value);
    }

    editor.id = void 0;
  }

  function cancelEditable(e) {
    e.preventDefault();
    editor.node.innerText = editor.value;
    editor.node.classList.remove('editor');
    editor.node.setAttribute('contenteditable', 'false');
    editor.node.removeEventListener('keydown', keyListener);
    editor.node.removeEventListener('click', ignoreClick);
    editor.editable.classList.remove('hover');

    editor.id = void 0;
  }

  async function saveTemplateName(name, id) {
    let template = $templates.find((tmpl) => tmpl.id === id);
    if (!template) return;
    let slug = generateSlug(name);
    const res = await api.put(`templates/${id}`, { name, slug }, $session.user && $session.user.token);
    if (res.success) {
      templates.put({ ...template, name, slug });
      configSnackbar($_('text.template-renamed'));
    } else {
      configSnackbar($_('text.template-could-not-be-renamed'));
    }
    snackbar.open();
    return res.success;
  }

  function isValidToken() {
    let expires;
    return (expires = currentUser.expires) && expires * 1000 > +new Date().getTime();
  }

  function generateName(name) {
    let newName = (name && name.concat($_('text.new-copy-label'))) || $_('text.new');
    let slug = slugify(newName);
    if ($templates.find((tmpl) => tmpl.slug === slug)) {
      return generateName(newName);
    }
    return { name: newName, slug };
  }

  function generateSlug(name) {
    let slug = slugify(name);
    if ($templates.find((tmpl) => tmpl.slug === slug)) {
      return generateSlug(slug.concat(' copy'));
    }
    return slug;
  }

  function gotoActive(active) {
    goto(activePath(active));
  }

  function templateMatch(value = '') {
    let matches = value.match(/(template):([\w-:\d]+)/);
    if (matches) return matches[2];
    return false;
  }

  function templateStringFromSlug(slug) {
    return `template:${slug}`;
  }
</script>

{#if $session.user}
  <div class="grid-item mail">
    <div class="drawer-container">
      <Drawer variant="dismissible" bind:this={drawer} bind:open={drawerOpen}>
        <Header>
          <Title>{username}</Title>
          <Subtitle>{email}</Subtitle>
        </Header>
        <Content>
          <List>
            <Item
              rel="prefetch"
              href={activePath('inboxes')}
              on:click={() => (selectionIndex = -1)}
              activated={active === 'inboxes'}
            >
              <Graphic class="material-icons" aria-hidden="true">inbox</Graphic>
              <Text>{$_('text.inbox')}</Text>
              <BadgeGroup right>
                {#if totalInboxes}
                  <Badge class="medium">{totalInboxes}</Badge>
                {/if}
                {#if totalInboxes && unreadInboxes > 0}
                  <Badge class="medium flash">{unreadInboxes}</Badge>
                {/if}
              </BadgeGroup>
            </Item>
            <Item
              rel="prefetch"
              href={activePath('sents')}
              on:click={() => (selectionIndex = -1)}
              activated={active === 'sents'}
            >
              <Graphic class="material-icons" aria-hidden="true">send</Graphic>
              <Text>{$_('text.sent')}</Text>
              {#if totalMails}
                <Badge class="medium" right>{totalMails}</Badge>
              {/if}
            </Item>

            <Separator />
            <div class="flex justify-between">
              <Subheader component={H6}>{$_('text.email-templates')}</Subheader>
              <Group>
                <IconButton
                  class="material-icons"
                  on:click={() => removeTemplate()}
                  toggle
                  aria-label={$_('text.template-remove')}
                  title={$_('text.template-remove')}
                  disabled={!currentTemplate || (currentTemplate && currentTemplate.protected)}
                >
                  remove
                </IconButton>
                <IconButton
                  class="material-icons"
                  on:click={() => duplicateTemplate()}
                  toggle
                  aria-label={$_('text.template-duplicate')}
                  title={$_('text.template-duplicate')}
                  disabled={!currentTemplate}
                >
                  file_copy
                </IconButton>
                <IconButton
                  class="material-icons"
                  on:click={() => addTemplate()}
                  toggle
                  aria-label={$_('text.template-add')}
                  title={$_('text.template-add')}
                >
                  add
                </IconButton>
              </Group>
            </div>

            {#each $templates.sort(sortAZ) as template (template.id)}
              <Item
                rel="prefetch"
                href={activePath(templateStringFromSlug(template.slug))}
                on:mouseover={(e) => hoverEditable(e)}
                on:mouseleave={(e) => leaveEditable(e)}
                activated={active === `template:${template.slug}`}
                class={template.slug === invalidSlug ? 'error' : ''}
              >
                <Graphic class="material-icons" aria-hidden="true">{template.protected ? 'lock' : 'bookmark'}</Graphic>
                <Text class={!template.protected && 'editable'}>{template.name}</Text>
                {#if !template.protected}
                  {#if editor.id === template.id}
                    <Meta class="edit">
                      <i on:click={(e) => cancelEditable(e)} class="material-icons">close</i>
                      <i on:click={(e) => saveEditable(e)} class="material-icons">check</i>
                    </Meta>
                  {:else}
                    <Meta on:click={(e) => makeEditable(e, template.id)} class="material-icons edit">edit</Meta>
                  {/if}
                {/if}
              </Item>
            {/each}
          </List>
        </Content>
      </Drawer>

      <AppContent class="app-content relative">
        <Button class="white" on:click={() => (drawerOpen = !drawerOpen)} style="position: absolute; z-index: 1;">
          <Icon class="material-icons">{drawerOpen ? 'menu_open' : 'view_sidebar'}</Icon>
        </Button>
        <main class="main-content">
          <div class="grid">
            <div class="toolbar">
              {#if create}
                <MailTemplateToolbar
                  {canSave}
                  on:template:reset={(e) => resetTemplate(e)}
                  on:template:save={(e) => saveTemplate(e)}
                />
              {:else}
                <MailToolbar
                  bind:selected
                  type={active}
                  on:mail:reload={(e) => reloadMails(e)}
                  on:mail:toggleRead={(e) => toggleRead(e)}
                  on:mail:delete={(e) => deleteMail(e)}
                  on:mail:sort={(e) => toggleSortByDate(e)}
                />
              {/if}
            </div>
            {#if create}
              {#if currentTemplate}
                <div class="grid-item grid-full">
                  <MailTemplate
                    bind:this={templateComponent}
                    bind:canSave
                    bind:working
                    template={{ ...currentTemplate, data: templateData }}
                    user={currentUser}
                  />
                </div>
              {:else}
                <div class="grid-item grid-full">
                  <div class="empty-selection">
                    <span style="text-align: center;">{$_('text.empty-template-selection')}</span>
                  </div>
                </div>
              {/if}
            {:else}
              <div class="grid-item grid-mail-list">
                <MailList
                  on:mail:delete={(e) => deleteMail(e)}
                  on:mail:toggleRead={(e) => toggleRead(e)}
                  bind:selected
                  bind:selectionIndex
                  type={active}
                  {sort}
                />
              </div>
              <div class="grid-item grid-mail-viewer">
                <MailViewer {selected} />
              </div>
            {/if}
          </div>
        </main>
      </AppContent>
    </div>
  </div>
{/if}
<Dialog
  bind:this={unsavedChangesDialog}
  aria-labelledby="info-title"
  aria-describedby="info-content"
  on:MDCDialog:closed={unsavedChangesDialogCloseHandler}
>
  <DialogTitle id="info-title">{$_('text.unsaved-changes')}</DialogTitle>
  <DialogContent id="info-content">
    <div class="item">
      {@html $_('messages.you-have-unsaved-changes')}
    </div>
  </DialogContent>
  <Actions>
    <Button action="cancel">
      <Label>{$_('text.cancel')}</Label>
    </Button>
    <Button action="discard" variant="unelevated" default use={[InitialFocus]}>
      <Label>{$_('text.discard-changes')}</Label>
    </Button>
  </Actions>
</Dialog>
{#if $fabs === 'send-mail'}
  <Fab class="floating-fab" color="primary" on:click={() => sendMail()} extended>
    <Label>{$_('text.send-mail')}</Label>
    <FabIcon class="material-icons">send</FabIcon>
  </Fab>
{/if}

<style>
  .mail {
    grid-area: one;
    overflow: auto;
  }
  .drawer-container {
    position: relative;
    display: flex;
    height: 100%;
    overflow: hidden;
    z-index: 0;
  }
  * :global(.app-content) {
    flex: auto;
    overflow: auto;
    position: relative;
    flex-grow: 1;
  }
  .main-content {
    overflow: auto;
    padding: 16px;
    height: 100%;
    box-sizing: border-box;
  }
  .grid {
    grid-template-areas:
      'toolbar toolbar'
      'one two';
    grid-template-columns: 2fr 3fr;
    grid-template-rows: 38px auto;
    grid-gap: var(--grid-gap);
    height: 100%;
  }
  .toolbar {
    grid-area: toolbar;
    margin-left: 70px;
  }
  .grid-mail-list {
    grid-area: one;
    overflow: auto;
  }
  .grid-mail-viewer {
    grid-area: two;
    overflow: auto;
  }
  .grid-full {
    grid-column-start: one;
    grid-column-end: two;
    overflow: auto;
  }
  .grid-item {
    background: var(--back-grid-item);
    height: 100%;
  }
  .empty-selection {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    font-size: 2em;
    font-weight: 600;
    color: #d8d8d8;
  }
  :global(.edit) {
    display: none;
  }
  :global(.hover .edit) {
    display: inline-flex;
  }
  :global(.editor)[contenteditable] {
    flex-basis: 55%;
    padding: 0.5em;
    border: 1px solid #eee;
    border-radius: 4px;
    overflow: auto;
    text-overflow: clip;
    pointer-events: all;
    cursor: initial;
  }
</style>
