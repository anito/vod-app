<script>
  import './drawer.scss';
  import * as api from 'api';
  import { onMount, getContext } from 'svelte';
  import { get } from 'svelte/store';
  import { stores } from '@sapper/app';
  import { fabs } from '../../stores/fabStore';
  import { users } from '../../stores/userStore';
  import { mails } from '../../stores/mailStore';
  import { inboxes } from '../../stores/inboxStore';
  import { templates } from '../../stores/templateStore';
  import MailViewer from './_MailViewer.svelte';
  import MailList from './_MailList.svelte';
  import MailToolbar from './_MailToolbar.svelte';
  import MailTemplateToolbar from './_MailTemplateToolbar.svelte';
  import MailTemplate from './_MailTemplate.svelte';
  import Badge from './_Badge.svelte';
  import BadgeGroup from './_BadgeGroup.svelte';
  import { _ } from 'svelte-i18n';
  import Drawer, { AppContent, Content, Header, Title, Subtitle, Scrim } from '@smui/drawer';
  import Button, { Group, Icon } from '@smui/button';
  import IconButton from '@smui/icon-button';
  import List, { Item, Text, Graphic, Separator, Subheader, Meta } from '@smui/list';
  import Fab, { Label, Icon as FabIcon } from '@smui/fab';
  import Dialog, { Title as DialogTitle, Content as DialogContent, Actions, InitialFocus } from '@smui/dialog';
  import H6 from '@smui/common/H6.svelte';

  export let selectionUserId = null;

  const { page, session } = stores();
  const { getSnackbar, configSnackbar } = getContext('snackbar');
  const { setFab } = getContext('fab');
  const sortAZ = (a, b) => (a.name > b.name ? 1 : a.name < b.name ? -1 : 0);
  const slugValidation = ['magic-link'];

  let drawer;
  let snackbar;
  let drawerOpen = true;
  let selected;
  let unreadInboxes = 0;
  let active = 'inboxes';
  let sort = 'DESC';
  let create = false;
  let root;
  let canSave;
  let working;
  let templateComponent;
  let unsavedChangesDialog;
  let editable;
  let editor = {};
  let pendingActiveTemplate;

  $: currentUser = ((id) => get(users).filter((usr) => usr.id === id))(selectionUserId)[0];
  $: username = currentUser && currentUser.name;
  $: totalMails = currentUser && $mails.length;
  $: totalInboxes = currentUser && $inboxes.length;
  $: unreadInboxes = currentUser && $inboxes.filter((mail) => !mail.read).length;
  $: email = currentUser && currentUser.email;
  $: currentUser && getInbox(currentUser);
  $: currentUser && getSent(currentUser);
  $: currentStore = active === 'inboxes' ? inboxes : active === 'mails' ? mails : null;
  $: create = !!active.template || false;
  $: create ? setFab('send-mail') : setFab('add-user');
  $: currentTemplate = $templates.find((tmpl) => tmpl.id === active.template) || null;
  $: templateData =
    currentTemplate &&
    ((slug) => {
      switch (slug) {
        case 'magic-link':
          if (!currentUser.token) return false;
          if (!isValidToken()) return false;
          return `http://${$page.host}/login?token=${currentUser && currentUser.token.token}`;
        default:
          return true;
      }
    })(currentTemplate.slug);
  $: invalidSlug =
    (currentTemplate &&
      slugValidation.find((slug) => slug === currentTemplate.slug) &&
      !templateData &&
      currentTemplate.slug) ||
    false;

  onMount(() => {
    root = document.documentElement;
    root.classList.add('mailmanager--open');

    snackbar = getSnackbar();
    getTemplates();

    return () => {
      root.classList.remove('mailmanager--open');
    };
  });

  async function sendMail() {
    const res = await api.post(
      'mails/add/',
      { email: currentUser.email, ...working, template: { slug: currentTemplate.slug, data: templateData } },
      $session.user && $session.user.token
    );
    if (res.success) {
      configSnackbar($_('text.message-sent-success'));
      reloadMails();
    } else {
      configSnackbar($_('text.message-sent-failed'));
    }
    snackbar.open();
  }

  async function getInbox(user) {
    let items = [],
      _users;
    const res = await api.get(`inboxes/get/${user.id}`, $session.user && $session.user.token);
    if (res.success) {
      res.data.map((mail) => {
        let message = JSON.parse(mail.message);
        items.push({
          id: mail.id,
          from: (_users = $users.filter((user) => user.email === mail._from)) && _users.length ? _users : [mail._from],
          to: [user],
          message: message.message,
          subject: message.subject,
          read: mail._read,
          created: mail.created,
        });
      });
      inboxes.update(items);
    }
  }

  async function getSent(user) {
    let items = [],
      _users;
    const res = await api.get(`mails/get/${user.id}`, $session.user && $session.user.token);
    if (res.success) {
      let _to;
      res.data.map((mail) => {
        let message = JSON.parse(mail.message);
        _to = mail._to.split(';');
        items.push({
          id: mail.id,
          from: [user],
          to: (_users = $users.filter((user) => _to.find((adr) => adr === user.email))) && _users.length ? _users : _to,
          message: message.message,
          subject: message.subject,
          read: true,
          created: mail.created,
        });
      });
      mails.update(items);
    }
  }

  async function setActiveList(value) {
    if (active.template && active.template != value.template && canSave) {
      pendingActiveTemplate = value;
      unsavedChangesDialog.open();
    } else {
      active = value;
    }
  }

  async function toggleRead(e) {
    let _selected, _read;
    _selected = e && e.detail.selected;
    _read = e && e.detail.read != void 0 ? e.detail.read : !_selected.read;
    const res = await api.put(`inboxes/${_selected.id}`, { _read }, $session.user && $session.user.token);
    if (res.success) {
      selected = { ..._selected, read: _read };
      inboxes.put(selected);
    }
  }

  async function deleteMail(e) {
    let _selected = e.detail.selected;
    const res = await api.del(`${active}/${_selected.id}`, $session.user && $session.user.token);
    if (res.success) {
      currentStore.del(_selected.id);
    }
  }

  function reloadMails() {
    currentUser = currentUser;
  }

  function toggleSortByDate() {
    sort = sort === 'DESC' ? 'ASC' : 'DESC';
  }

  function newMail(template) {
    create = true;
  }

  async function getTemplates() {
    const res = await api.get('email_templates', $session.user && $session.user.token);
    if (res.success) {
      templates.update(res.data);
    }
  }

  function resetTemplate() {
    templateComponent.resetTemplate();
  }

  function addTemplate() {}

  async function saveTemplate() {
    let updated = { ...currentTemplate, ...working };
    const res = await api.put(
      `email_templates/${currentTemplate.id}`,
      { ...working },
      $session.user && $session.user.token
    );
    if (res.success) {
      configSnackbar($_('text.template-saved'));
      templates.put(updated);
    } else {
      configSnackbar($_('text.template-save-failed'));
    }
    snackbar.open();
  }

  async function duplicateTemplate() {
    let duplicate = { ...working, name: currentTemplate.name.concat(' Copy'), protected: false };
    const res = await api.post('email_templates', { ...duplicate }, $session.user && $session.user.token);
    if (res.success) {
      configSnackbar($_('text.template-duplicated'));
      templates.add({ ...currentTemplate, ...duplicate, id: res.data.id });
      active.template = res.data.id;
    } else {
      configSnackbar($_('text.template-duplicated-failed'));
    }
    snackbar.open();
  }

  async function removeTemplate() {
    const res = await api.del(`email_templates/${currentTemplate.id}`, $session.user && $session.user.token);
    if (res.success) {
      configSnackbar($_('text.template-removed'));
      templates.del(currentTemplate.id);
    } else {
      configSnackbar($_('text.template-could-not-be-removed'));
    }
    snackbar.open();
  }

  function unsavedChangesDialogCloseHandler(e) {
    if (e.detail.action === 'discard') {
      pendingActiveTemplate && (active = pendingActiveTemplate);
      pendingActiveTemplate = void 0;
    }
  }

  function hoverEditable(e) {
    editable = e.currentTarget;
    editable && editable.classList.add('hover');
  }

  function leaveEditable(e) {
    if (editable && editable.getElementsByClassName('editor').length) return;
    editable && editable.classList.remove('hover');
  }

  function makeEditable(id) {
    let range = document.createRange();
    let selection = window.getSelection();
    let children = editable.getElementsByClassName('editable');
    let node = children.length && children[0];

    editor.node && editor.node.classList.remove('editor');

    editor = { id, node, value: node.innerText, editable };
    editor.node.classList.add('editor');
    editor.node.setAttribute('contenteditable', 'true');
    editor.node.focus();
    range.selectNodeContents(editor.node);
    range.collapse(false);
    selection.removeAllRanges();
    selection.addRange(range);
  }

  function saveEditable() {
    editor.node.classList.remove('editor');
    editor.editable.classList.remove('hover');
    if (editor.value !== editor.node.innerText) save(editor.node.innerText);

    editor.id = void 0;
  }

  function cancelEditable() {
    editor.node.innerText = editor.value;
    editor.node.classList.remove('editor');
    editor.editable.classList.remove('hover');

    editor.id = void 0;
  }

  async function save(val) {
    const res = await api.put(
      `email_templates/${currentTemplate.id}`,
      { name: val },
      $session.user && $session.user.token
    );
    if (res.success) {
      configSnackbar($_('text.template-saved'));
    } else {
      configSnackbar($_('text.template-save-failed'));
    }
    snackbar.open();
  }

  function isValidToken() {
    let expires;
    return (expires = currentUser.expires) && expires * 1000 > +new Date().getTime();
  }
</script>

{#if $session.user}
  <div class="grid-item mail">
    <div class="drawer-container">
      <Drawer variant="dismissible" bind:this={drawer} bind:open={drawerOpen}>
        <Header>
          <Title>{username}</Title>
          <Subtitle>{email}</Subtitle>
        </Header>
        <Content>
          <List>
            <Item href="" on:click={() => setActiveList('inboxes')} activated={active === 'inboxes'}>
              <Graphic class="material-icons" aria-hidden="true">inbox</Graphic>
              <Text>{$_('text.inbox')}</Text>
              <BadgeGroup right>
                {#if totalInboxes}
                  <Badge class="medium">{totalInboxes}</Badge>
                {/if}
                {#if totalInboxes && unreadInboxes > 0}
                  <Badge class="medium flash">{unreadInboxes}</Badge>
                {/if}
              </BadgeGroup>
            </Item>
            <Item href="" on:click={() => setActiveList('mails')} activated={active === 'mails'}>
              <Graphic class="material-icons" aria-hidden="true">send</Graphic>
              <Text>{$_('text.sent-mail')}</Text>
              {#if totalMails}
                <Badge class="medium" right>{totalMails}</Badge>
              {/if}
            </Item>

            <Separator />
            <div class="flex justify-between">
              <Subheader component={H6}>{$_('text.email-templates')}</Subheader>
              <Group>
                <IconButton
                  class="material-icons"
                  on:click={() => removeTemplate()}
                  toggle
                  aria-label={$_('text.template-remove')}
                  title={$_('text.template-remove')}
                  disabled={!currentTemplate || (currentTemplate && currentTemplate.protected)}
                >
                  remove
                </IconButton>
                <IconButton
                  class="material-icons"
                  on:click={() => duplicateTemplate()}
                  toggle
                  aria-label={$_('text.template-duplicate')}
                  title={$_('text.template-duplicate')}
                  disabled={!currentTemplate}
                >
                  file_copy
                </IconButton>
                <IconButton
                  class="material-icons"
                  on:click={() => addTemplate()}
                  toggle
                  aria-label={$_('text.template-add')}
                  title={$_('text.template-add')}
                >
                  add
                </IconButton>
              </Group>
            </div>

            {#each $templates.sort(sortAZ) as template (template.id)}
              <Item
                on:click={() => setActiveList({ template: template.id })}
                on:mouseover={(e) => hoverEditable(e)}
                on:mouseleave={(e) => leaveEditable(e)}
                activated={active.template === template.id}
                class={template.slug === invalidSlug ? 'error' : ''}
              >
                <Graphic class="material-icons" aria-hidden="true">{template.protected ? 'lock' : 'bookmark'}</Graphic>
                <Text class={!template.protected && 'editable'}>{template.name}</Text>
                {#if !template.protected}
                  {#if editor.id === template.id}
                    <Meta class="edit">
                      <i on:click={(e) => cancelEditable()} class="material-icons">close</i>
                      <i on:click={(e) => saveEditable()} class="material-icons">check</i>
                    </Meta>
                  {:else}
                    <Meta on:click={(e) => makeEditable(template.id)} class="material-icons edit">edit</Meta>
                  {/if}
                {/if}
              </Item>
            {/each}
          </List>
        </Content>
      </Drawer>

      <AppContent class="app-content relative">
        <Button class="white" on:click={() => (drawerOpen = !drawerOpen)} style="position: absolute; z-index: 1;">
          <Icon class="material-icons">{drawerOpen ? 'menu_open' : 'view_sidebar'}</Icon>
        </Button>
        <main class="main-content">
          <div class="grid">
            <div class="toolbar">
              {#if create}
                <MailTemplateToolbar
                  {canSave}
                  template={currentTemplate}
                  on:template:reset={(e) => resetTemplate(e)}
                  on:template:save={(e) => saveTemplate(e)}
                />
              {:else}
                <MailToolbar
                  bind:selected
                  type={active}
                  on:mail:reload={(e) => reloadMails(e)}
                  on:mail:toggleRead={(e) => toggleRead(e)}
                  on:mail:delete={(e) => deleteMail(e)}
                  on:mail:sort={(e) => toggleSortByDate(e)}
                />
              {/if}
            </div>
            {#if create}
              {#if currentTemplate}
                <div class="grid-item grid-full">
                  <MailTemplate
                    bind:this={templateComponent}
                    bind:canSave
                    bind:working
                    template={{ ...currentTemplate, template: { ...currentTemplate.template, data: templateData } }}
                    user={currentUser}
                  />
                </div>
              {:else}
                <div class="grid-item grid-full">
                  <div class="empty-selection">
                    <span style="text-align: center;">{$_('text.empty-template-selection')}</span>
                  </div>
                </div>
              {/if}
            {:else}
              <div class="grid-item grid-mail-list">
                <MailList on:mail:toggleRead={(e) => toggleRead(e)} bind:selected type={active} {sort} />
              </div>
              <div class="grid-item grid-mail-viewer">
                <MailViewer {selected} />
              </div>
            {/if}
          </div>
        </main>
      </AppContent>
    </div>
  </div>
{/if}
<Dialog
  bind:this={unsavedChangesDialog}
  aria-labelledby="info-title"
  aria-describedby="info-content"
  on:MDCDialog:closed={unsavedChangesDialogCloseHandler}
>
  <DialogTitle id="info-title">{$_('text.unsaved-changes')}</DialogTitle>
  <DialogContent id="info-content">
    <div class="item">
      {@html $_('messages.you-have-unsaved-changes')}
    </div>
  </DialogContent>
  <Actions>
    <Button action="cancel">
      <Label>{$_('text.cancel')}</Label>
    </Button>
    <Button action="discard" variant="unelevated" default use={[InitialFocus]}>
      <Label>{$_('text.discard-changes')}</Label>
    </Button>
  </Actions>
</Dialog>
{#if $fabs === 'send-mail'}
  <Fab class="floating-fab" color="primary" on:click={() => sendMail()} extended>
    <Label>{$_('text.send-mail')}</Label>
    <FabIcon class="material-icons">send</FabIcon>
  </Fab>
{/if}

<style>
  .mail {
    grid-area: one;
    overflow: auto;
  }
  .drawer-container {
    position: relative;
    display: flex;
    height: 100%;
    overflow: hidden;
    z-index: 0;
  }
  * :global(.app-content) {
    flex: auto;
    overflow: auto;
    position: relative;
    flex-grow: 1;
  }
  .main-content {
    overflow: auto;
    padding: 16px;
    height: 100%;
    box-sizing: border-box;
  }
  .grid {
    grid-template-areas:
      'toolbar toolbar'
      'one two';
    grid-template-columns: 2fr 3fr;
    grid-template-rows: 38px auto;
    grid-gap: var(--grid-gap);
    height: 100%;
  }
  .toolbar {
    grid-area: toolbar;
    margin-left: 70px;
  }
  .grid-mail-list {
    grid-area: one;
    overflow: auto;
  }
  .grid-mail-viewer {
    grid-area: two;
    overflow: auto;
  }
  .grid-full {
    grid-column-start: one;
    grid-column-end: two;
    overflow: auto;
  }
  .grid-item {
    background: var(--back-grid-item);
    height: 100%;
  }
  .empty-selection {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    font-size: 2em;
    font-weight: 600;
    color: #d8d8d8;
  }
  :global(.edit) {
    display: none;
  }
  :global(.hover .edit) {
    display: inline-flex;
  }
  :global(.editor)[contenteditable] {
    padding: 0.5em;
    border: 1px solid #eee;
    border-radius: 4px;
    overflow: hidden;
    pointer-events: all;
    cursor: initial;
  }
</style>
