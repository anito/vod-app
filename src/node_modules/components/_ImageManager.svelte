<script context="module">
  import * as api from "api.js";
  import { images } from "../../stores/imageStore";
  import { urls } from "../../stores/urlStore";
  import { get as receive } from "svelte/store";
  import { equals } from "utils";

  export async function preload({ path }, { user }) {
    let imgs;
    let data;
    const res = await api.get("images", user && user.token);

    if (res && res.success) {
      imgs = receive(images);
      data = res.data;
      if (!equals(imgs, data)) images.set(data);
    } else {
      images.set([]);
    }
  }
</script>

<script>
  import { stores, goto } from "@sapper/app";
  import { onMount, getContext } from "svelte";
  import { fly } from "svelte/transition";
  import Fab, { Icon } from "@smui/fab";
  import { Label } from "@smui/common";
  import Paper, { Title, Subtitle, Content } from "@smui/paper";
  import ImageCard from "./_ImageCard.svelte";
  import MediaUploader from "./_MediaUploader.svelte";
  import Info from "./_Info.svelte";
  import { currentImage } from "../../stores/currentImageStore";

  const { session } = stores();
  const { open } = getContext("simple-modal");
  const { getSnackbar, configSnackbar } = getContext("snackbar");

  let snackbar;
  let openUploader = () => {
    open(
      MediaUploader,
      {
        type: "image",
        options: {
          uploadMultiple: true,
          parallelUploads: 12,
          maxFiles: 12,
        },
        events: { uploadDone },
      },
      {
        transitionWindow: fly,
        transitionWindowProps: {
          y: -200,
          duration: 500,
        },
      }
    );
  };

  $: user = $session.user;

  onMount(() => {
    snackbar = getSnackbar();
  });

  function uploadDone(e) {
    if (e.detail && e.detail.success) {
      let data = e.detail.data;
      images.add(data);
    }
    if (e.detail.message) {
      configSnackbar(e.detail.message);
      snackbar.open();
    }
  }

  function setCurrentImage(e) {
    currentImage.set(e.detail);
  }

  async function deletePoster(e) {
    let message,
      image = e.detail.image;
    const id = image.id;
    const res = await api.del(`images/${image.id}`, user && user.token);

    message = res.message || res.data.message || res.statusText;
    if (res) {
      if (res.success) {
        urls.del(id);
        images.del(id);
      }
      configSnackbar(message);
      snackbar.open();
    }
  }
</script>

<style>
</style>

<svelte:head>
  <title>Physiotherapy Online | Video Posters</title>
</svelte:head>

<div class="lg:p-8">
  {#if $session.user}
    {#if $images.length}
      <div class="flex flex-wrap flex-row justify-center lg:justify-start">
        {#each $images as image (image.id)}
          <div class="flex m-1">
            <ImageCard
              on:Image:lastSelected={setCurrentImage}
              on:Image:delete={deletePoster}
              {image} />
          </div>
        {/each}
      </div>
    {:else}
      <div class="paper-container flex justify-center">
        <Paper color="primary">
          <Title style="color: var(--text-light)">No Images available</Title>
          <Content>
            <a
              href="/images"
              on:click|preventDefault={() => openUploader()}>Upload</a>
            some images to your content
          </Content>
        </Paper>
      </div>
    {/if}
    <Fab
      class="floating-fab"
      color="primary"
      on:click={() => openUploader()}
      extended>
      <Label>Neues Poster</Label>
      <Icon class="material-icons">add</Icon>
    </Fab>
  {:else}
    <div class="paper-container flex justify-center m-8">
      <Info title="Unauthorized" let:href>
        <a {href} on:click|preventDefault={() => goto(href)}>Login</a>
      </Info>
    </div>
  {/if}
</div>
