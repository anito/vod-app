<script context="module">
  import * as api from 'api';
  import { images } from '../../stores/imageStore';
  import { urls } from '../../stores/urlStore';
  import { get as receive } from 'svelte/store';
  import { equals } from 'utils';
  import { _ } from 'svelte-i18n';

  export async function preload({ path }, { user }) {
    let imgs;
    let data;
    const res = await api.get('images', user && user.token);

    if (res && res.success) {
      imgs = receive(images);
      data = res.data;
      if (!equals(imgs, data)) images.set(data);
    } else {
      images.set([]);
    }
  }
</script>

<script>
  import { stores, goto } from '@sapper/app';
  import { onMount, getContext } from 'svelte';
  import { fly } from 'svelte/transition';
  import Fab, { Icon } from '@smui/fab/styled';
  import { Label } from '@smui/common/styled';
  import Paper, { Title, Subtitle, Content } from '@smui/paper/styled';
  import ImageCard from './_ImageCard.svelte';
  import MediaUploader from './_MediaUploader.svelte';
  import Info from './_Info.svelte';
  import { locale } from 'svelte-i18n';
  import { fabs } from '../../stores/fabStore';

  const { session } = stores();
  const { open } = getContext('simple-modal');
  const { getSnackbar, configSnackbar } = getContext('snackbar');
  const { setFab, restoreFab } = getContext('fab');

  let snackbar;
  let openUploader = () => {
    open(
      MediaUploader,
      {
        type: 'image',
        options: {
          uploadMultiple: true,
          parallelUploads: 12,
          maxFiles: 12,
        },
        events: { uploadDone },
      },
      {
        transitionWindow: fly,
        transitionWindowProps: {
          y: -200,
          duration: 500,
        },
      }
    );
  };

  $: user = $session.user;

  onMount(() => {
    snackbar = getSnackbar();
    setFab('upload-image');
  });

  function uploadDone(e) {
    let detail = e.detail;
    if (detail.success) {
      images.add(detail.data);
    }
    if (detail.message) {
      configSnackbar(e.detail.message);
      snackbar.open();
    }
  }

  async function deletePoster(e) {
    let detail = e.detail;
    let image = detail.image;
    let message;
    const id = image.id;
    const res = await api.del(`images/${image.id}?lang=${$locale}`, user && user.token);

    message = res.message || res.data.message || res.statusText;
    if (res) {
      if (res.success) {
        urls.del(id);
        images.del(id);
      }
      configSnackbar(message);
      snackbar.open();
    }
  }
</script>

<svelte:head>
  <title>Physiotherapy Online | Video Posters</title>
</svelte:head>

<div class="lg:p-8">
  {#if $session.user}
    {#if $images.length}
      <div class="flex flex-wrap flex-row justify-center lg:justify-start">
        {#each $images as image (image.id)}
          <div class="flex m-1">
            <ImageCard on:Image:delete={deletePoster} {image} />
          </div>
        {/each}
      </div>
    {:else}
      <div class="paper-container flex justify-center">
        <Paper color="primary">
          <Title style="color: var(--text-light)">No Images available</Title>
          <Content>
            <a href="/images" on:click|preventDefault={() => openUploader()}>Upload</a>
            some images to your content
          </Content>
        </Paper>
      </div>
    {/if}
    {#if $fabs === 'upload-image'}
      <Fab class="floating-fab" color="primary" on:click={() => openUploader()} extended>
        <Label>{$_('text.new-poster')}</Label>
        <Icon class="material-icons">add</Icon>
      </Fab>
    {/if}
  {:else}
    <div class="paper-container flex justify-center m-8">
      <Info title="Unauthorized" let:href>
        <a {href} on:click|preventDefault={() => goto(href)}>Login</a>
      </Info>
    </div>
  {/if}
</div>

<style>
</style>
