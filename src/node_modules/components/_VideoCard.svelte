<script>
  import "./_button.scss";
  import "./_menu-surface.scss";
  import { stores } from "@sapper/app";
  import { getContext, createEventDispatcher } from "svelte";
  import { fly } from "svelte/transition";
  import { videoEmitter, currentVideo } from "stores";
  import { getMedia } from "utils/media";
  import VideoMedia from "./_VideoMedia.svelte";
  import MediaUploader from "./_MediaUploader.svelte";
  import Card, {
    Content,
    PrimaryAction,
    Actions,
    ActionButtons,
    ActionIcons,
  } from "@smui/card";
  import Button, { Label } from "@smui/button";
  import IconButton, { Icon } from "@smui/icon-button";
  import Menu from "@smui/menu";
  import MenuSurface, { Anchor } from "@smui/menu-surface";
  import ImageList, {
    Item as ImageListItem,
    ImageAspectContainer,
    Image,
  } from "@smui/image-list";
  import List, { Item, Separator, Text } from "@smui/list";
  import { images } from "stores";

  import { _, locale } from "svelte-i18n";

  export let video;
  export { className as class };

  const { open } = getContext("simple-modal");
  const { session } = stores();

  let user = $session.user;
  let className = "";
  let cardMenu;
  let deleteMenu;
  let dispatch = createEventDispatcher();
  let imageList;
  let imageListAnchor;
  let isEditMode = false;
  let title;
  let description;
  let dateOptions = {
    day: "2-digit",
    year: "numeric",
    month: "2-digit",
  };
  let isImageListOpen = false;

  $: leftButton = isEditMode
    ? { label: $_("text.save"), icon: "save" }
    : { label: $_("text.edit"), icon: "edit" };
  $: rightButton = isEditMode
    ? { label: $_("text.cancel"), icon: "cancel" }
    : { label: $_("text.delete"), icon: "delete" };
  $: matchingData =
    (video["_matchingData"] && video["_matchingData"]["UsersVideos"]) || null;
  $: canSave = description !== video.description || title !== video.title;
  $: image = $images.find((i) => video.image_id === i.id);

  function save() {
    video.title = title;
    video.description = description;
    videoEmitter.dispatch({
      method: "put",
      data: video,
      snack: true,
    });
    isEditMode = false;
    return false;
  }

  function edit() {
    title = video.title || "";
    description = video.description || "";
    return true;
  }

  function setDeleteMenuOpen(bol) {
    deleteMenu.setOpen(bol);
    return false;
  }

  function del() {
    videoEmitter.dispatch({
      method: "del",
      data: video,
      snack: true,
    });
  }

  function createPoster(type) {
    open(
      MediaUploader,
      {
        type,
        options: {
          uploadMultiple: false,
          parallelUploads: 1,
          maxFiles: 1,
        },
        events: { uploadDone },
      },
      {
        transitionWindow: fly,
        transitionWindowProps: {
          y: -200,
          duration: 500,
        },
      }
    );
  }

  function getCachedImage(id) {
    let res = getMedia("IMAGE", id, user, {
      width: 100,
      height: 100,
      square: 1,
    });
    return res;
  }

  function uploadDone(e) {
    dispatch("Video:posterCreated", e.detail);
  }

  function imageListOpenedHandler(e) {
    isImageListOpen = true;
  }

  function imageListClosedHandler(e) {
    isImageListOpen = false;
  }

  function cardMenuOpenedHandler(e) {
    $currentVideo !== video && currentVideo.set(video);
  }
</script>

<Card
  class="flex content-between card {className}"
  style="width: var(--player-w);"
>
  <PrimaryAction>
    <VideoMedia {video} bind:title bind:description {isEditMode} />
    <Content class="mdc-typography--body2">
      {#if "Administrator" === $session.role}
        <div class="text-xs text-inherit">
          <Icon class="material-icons">cloud_upload</Icon>
          <span
            >{$_("text.uploaded-on", {
              values: {
                date: new Date(video.created).toLocaleDateString(
                  $locale,
                  dateOptions
                ),
              },
            })}</span
          >
        </div>
        <div class="opacity-25">
          <div class="flex text-xs text-inherit">
            <Icon class="material-icons">image</Icon>
            <span class="flex-1 poster-label">Poster:</span>
            <span class="flex-1 poster-name"
              >{(image && image.src) || $_("text.no-poster")}</span
            >
          </div>
        </div>
      {:else}
        <div class="">
          <div class="flex justify-between">
            <Label style="align-self: center; padding: 0 20px;">
              {@html $_("messages.video-available-until")}
            </Label>
            <div class="date-button ">
              <Button
                color="primary"
                variant="unelevated"
                class="button-shaped-round extended"
              >
                <Icon class="material-icons">date_range</Icon>
                <Label>
                  {@html $_("text.until-date", {
                    values: {
                      date:
                        matchingData &&
                        new Date(matchingData.end).toLocaleDateString(
                          $locale,
                          dateOptions
                        ),
                    },
                  })}
                </Label>
              </Button>
            </div>
          </div>
        </div>
      {/if}
    </Content>
  </PrimaryAction>
  {#if "Administrator" === $session.role}
    <Actions class="card-actions">
      <ActionButtons class="action-buttons">
        <Button
          color="primary"
          class="action-button"
          disabled={isEditMode && !canSave}
          on:click={() => (isEditMode = !isEditMode && edit()) || save()}
        >
          <Label>{leftButton.label}</Label>
          <Icon class="material-icons">{leftButton.icon}</Icon>
        </Button>
        <Button
          color="primary"
          class="action-button"
          on:click={() => (isEditMode = !isEditMode && setDeleteMenuOpen(true))}
        >
          <Label>{rightButton.label}</Label>
          <Icon class="material-icons">{rightButton.icon}</Icon>
        </Button>
        <ActionIcons style="position: relative;">
          <IconButton
            class="material-icons"
            on:click={() => cardMenu.setOpen(true)}
            toggle
            aria-label={$_("text.more-options")}
            title={$_("text.more-options")}>more_vert</IconButton
          >
          <Menu
            bind:this={cardMenu}
            on:MDCMenuSurface:opened={cardMenuOpenedHandler}
          >
            <List class="menu-list">
              <Item on:click={() => createPoster("image")}>
                <Text>{$_("text.new-poster")}</Text>
              </Item>
              <Item
                disabled={!$images.length}
                on:click={() => imageList.setOpen(true)}
              >
                <Text>{$_("text.select-poster")}</Text>
              </Item>
              <Separator />
              <Item
                disabled={!video.image_id}
                on:SMUI:action={() =>
                  dispatch("Video:removePoster", video.image_id)}
              >
                <Text>{$_("text.remove-poster")}</Text>
              </Item>
              <Item class="text-red-700" on:SMUI:action={() => del()}>
                <Text>{$_("text.delete-video")}</Text>
              </Item>
            </List>
          </Menu>
          <Menu bind:this={deleteMenu}>
            <List>
              <Item class="text-red-700" on:SMUI:action={() => del()}>
                <Text>{$_("text.delete-video")}</Text>
              </Item>
            </List>
          </Menu>
        </ActionIcons>
      </ActionButtons>
      <div
        use:Anchor
        bind:this={imageListAnchor}
        style="top: -320px; right: 250px;"
      >
        <MenuSurface
          bind:this={imageList}
          bind:anchorElement={imageListAnchor}
          anchor={false}
          anchorCorner="TOP_RIGHT"
          on:MDCMenuSurface:opened={imageListOpenedHandler}
          on:MDCMenuSurface:closed={imageListClosedHandler}
        >
          <ImageList class="menu-surface-image-list">
            {#if isImageListOpen}
              {#each $images as image, i (image.id)}
                {#await getCachedImage(image.id)}
                  <div />
                {:then src}
                  <ImageListItem>
                    <ImageAspectContainer>
                      <Image
                        class="preview-image"
                        on:click={() =>
                          dispatch("Video:selectPoster", image.id)}
                        {src}
                      />
                    </ImageAspectContainer>
                  </ImageListItem>
                {/await}
              {/each}
            {/if}
          </ImageList>
        </MenuSurface>
      </div>
    </Actions>
  {/if}
</Card>

<style>
  :global(.preview-image) {
    cursor: pointer;
  }
  .poster-label {
    flex-basis: 20%;
    max-width: 20%;
  }
  .poster-name {
    flex-basis: 80%;
    max-width: 80%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
</style>
