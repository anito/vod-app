<script>
  import { stores } from "@sapper/app";
  import { createEventDispatcher } from "svelte";
  import { Icon } from "@smui/button";
  import {
    Item,
    Graphic,
    Meta,
    Separator,
    Subheader,
    Text,
    PrimaryText,
    SecondaryText,
  } from "@smui/list";
  import { getMedia, readoutDuration, hasStarted, isExpired } from "utils";
  import { parseISO } from "date-fns";
  import { localeFormat } from "@sveltejs/site-kit";
  import { users } from "../../../stores/userStore";

  export let video;
  export let disabled = false;
  export let selectionUserId = null;
  export { className as class };
  export let emptyDateText = "";
  export let emphasizeEmptyDate = false;
  export let threeLine = false;
  export let selected = false;

  const { session } = stores();
  const base = "https://via.placeholder.com/40x40.png?text=";

  let dispatch = createEventDispatcher();
  let className = "";
  let src;
  let _video;
  let startDate;
  let filtered;
  let user = $session.user;
  let dateFormat = "dd. MMM yyyy";
  let item;

  $: video && backgroundImageSrc(video);
  $: unmanagable = !user || !selectionUserId || disabled;
  $: currentUser =
    (filtered = ((id) => $users.filter((usr) => usr.id === id))(
      selectionUserId
    )) &&
    filtered.length &&
    filtered[0];
  $: joinData =
    (_video = currentUser.videos.find((v) => v.id === video.id)) &&
    _video._joinData;
  $: startDate = joinData && joinData.start && parseISO(joinData.start);
  $: endDate =
    (joinData && joinData.end && parseISO(joinData.end)) || startDate;
  $: emptyDate = () => !(joinData && joinData.start);
  $: duration = () => (joinData && readoutDuration(startDate, endDate)) || "--";
  $: pending = () => joinData && !hasStarted(startDate);
  $: expired = () => joinData && isExpired(endDate);
  $: timerOff = () => (joinData && expired()) || emptyDate();
  $: readout = () => getReadout(joinData);

  function getReadout(data) {
    if (!data || !data.start) {
      return emptyDateText.toString();
    } else {
      return `${localeFormat(
        parseISO(data.start),
        dateFormat
      )} - ${localeFormat(parseISO(data.end), dateFormat)}`;
    }
  }

  async function backgroundImageSrc(video) {
    let initials;

    if (video.title) {
      initials = video.title
        .split(" ")
        .map((val) => val.substring(0, 1))
        .join("");
      src = `${base}${initials}`;
    } else {
      src = base;
    }

    const res = await getPosterUrl(video.image_id);
    if (res) src = res;
  }

  async function getPosterUrl(id) {
    if (id) {
      // options.square: 0 => intelligent resize (keep ratio) |Â 1 => force resize | 2 => no resize (original)
      const res = await getMedia("IMAGE", id, user, {
        width: 40,
        height: 40,
        square: 1,
      });
      if (res) return res;
    }
  }
</script>

<style>
  .item {
    position: relative;
    display: block;
  }
  :global(.user-video) .date,
  :global(.user-video) .expired {
    color: var(--text-light);
    padding: 3px 6px;
    line-height: 1.5em;
    font-size: 0.7rem;
  }
  .action-buttons {
    display: flex;
    flex: 1;
    flex-direction: row-reverse;
  }
  .info {
    background: rgb(27, 85, 27);
  }
  .expired {
    background: var(--back-dark);
  }
  .pending {
    background: rgb(47, 110, 247);
  }
  .alert {
    background: var(--error);
  }
</style>

<div class="item {className}">
  <Item
    disabled={unmanagable}
    bind:this={item}
    on:SMUI:action={() => dispatch('itemSelected', { video })}
    {selected}
    class={selected ? 'mdc-list-item--selected' : ''}>
    <Graphic style="background-image: url({src});" />
    <Text>
      <PrimaryText>
        <span class="opacity-25" class:opacity-25={!video.title}>
          {`${video.title} ${selected ? 'selected' : ''}` || 'No Title'}
        </span>
      </PrimaryText>
      <SecondaryText>
        <span
          class="date"
          class:info={!emptyDate()}
          class:expired={expired()}
          class:pending={pending()}
          class:alert={emptyDate() && emphasizeEmptyDate}>
          {readout()}
        </span>
      </SecondaryText>
      {#if threeLine}
        <SecondaryText>
          <span class="text-xs text-inherit">
            <Icon class="material-icons">
              {timerOff() ? 'timer_off' : 'timer'}
            </Icon>
            <span>{duration()}</span>
            <span>{pending() ? ' (pending)' : ''}</span>
          </span>
        </SecondaryText>
      {/if}
    </Text>
    <span class="action-buttons">
      <slot published={!emptyDate()} {unmanagable} />
    </span>
  </Item>
</div>
